name: Owner App Build (iOS IPA - Debug)

on:
  repository_dispatch:
    types: [owner_app_build_ios]

permissions:
  contents: read

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions (safe)
        run: |
          flutter --version
          dart --version

      - name: Install CocoaPods
        run: |
          sudo gem install cocoapods -N
          pod --version

      # Optional: build ci_env.json like Android (safe summary only)
      - name: Build ci_env.json (safe)
        run: |
          set -e
          mkdir -p lib/env

          python3 - <<'PY'
          import json, re

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          def pick(key, default=None):
              v = cfg.get(key)
              if v not in (None,"",[]):
                  return v
              v = payload.get(key)
              if v not in (None,"",[]):
                  return v
              return default

          api_base = (pick("API_BASE_URL","") or "").rstrip("/")
          link_id  = str(pick("OWNER_PROJECT_LINK_ID","") or pick("ownerProjectLinkId","")).strip()

          if not api_base or not link_id:
              raise SystemExit("Missing API_BASE_URL or OWNER_PROJECT_LINK_ID in payload/CONFIG")

          app_name = pick("APP_NAME","My App")
          app_type = pick("APP_TYPE","ECOMMERCE")

          env = {
            "API_BASE_URL": api_base,
            "OWNER_PROJECT_LINK_ID": link_id,
            "APP_NAME": app_name,
            "APP_TYPE": app_type,
            "CONFIG_SOURCE": "PAYLOAD_ONLY_IOS",
          }

          with open("lib/env/ci_env.json","w",encoding="utf-8") as f:
              json.dump(env,f,ensure_ascii=False,indent=2)

          # SAFE PRINTS (no secrets)
          print("---- iOS CI ENV (safe summary) ----")
          print("API_BASE_URL =", api_base)
          print("OWNER_PROJECT_LINK_ID =", link_id)
          print("APP_NAME =", app_name)
          print("APP_TYPE =", app_type)
          print("CONFIG_SOURCE =", env["CONFIG_SOURCE"])
          PY

      - name: Check exportOptions.plist exists
        run: |
          set -e
          if [ ! -f "ios/exportOptions.plist" ]; then
            echo "❌ Missing ios/exportOptions.plist"
            exit 1
          fi
          echo "✅ exportOptions.plist found"

      - name: Setup iOS signing (Debug safe)
        env:
          IOS_P12_B64: ${{ secrets.IOS_P12_B64 }}
          IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
          IOS_MOBILEPROVISION_B64: ${{ secrets.IOS_MOBILEPROVISION_B64 }}
        run: |
          set -e

          # SAFE: just show lengths (not values)
          echo "P12_B64_LEN=${#IOS_P12_B64}"
          echo "PROFILE_B64_LEN=${#IOS_MOBILEPROVISION_B64}"

          # Create temp keychain
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          # Import certificate
          echo "$IOS_P12_B64" | base64 --decode > ios_cert.p12
          security import ios_cert.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -T /usr/bin/codesign
          security list-keychains -d user -s build.keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain

          # Install provisioning profile
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          echo "$IOS_MOBILEPROVISION_B64" | base64 --decode > profile.mobileprovision

          UUID=$(/usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin <<< "$(security cms -D -i profile.mobileprovision)")
          NAME=$(/usr/libexec/PlistBuddy -c 'Print :Name' /dev/stdin <<< "$(security cms -D -i profile.mobileprovision)" || true)

          cp profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "✅ Provisioning profile installed"
          echo "UUID=$UUID"
          echo "NAME=$NAME"

      - name: Pub get
        run: flutter pub get

      - name: Pod install
        run: |
          cd ios
          pod install
          cd ..

      - name: Print iOS bundle info (safe)
        run: |
          set -e
          if [ -f "ios/Runner/Info.plist" ]; then
            echo "✅ Info.plist exists"
          else
            echo "⚠️ Info.plist not found at ios/Runner/Info.plist (may still be ok depending on structure)"
          fi

      - name: Build IPA (App Store/TestFlight)
        run: |
          flutter build ipa --release \
            --dart-define-from-file=lib/env/ci_env.json \
            --export-options-plist=ios/exportOptions.plist

      - name: List build outputs (debug)
        run: |
          set -e
          echo "---- IPA folder ----"
          ls -la build/ios/ipa || true
          echo "---- Archive folder ----"
          ls -la build/ios/archive || true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
