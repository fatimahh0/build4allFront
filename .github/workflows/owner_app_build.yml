name: Owner App Build (APK + AAB + Play Internal)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

    steps:
      # --------------------------------------------
      # Checkout
      # --------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # --------------------------------------------
      # Java + Flutter
      # --------------------------------------------
      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"
          cache: gradle

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: |
          echo '${{ toJson(github.event.client_payload) }}'

      # --------------------------------------------
      # Force NDK + compileSdk 36 (plugin needs 36)
      # --------------------------------------------
      - name: Force Android NDK 27 + compileSdk 36
        shell: bash
        run: |
          set -euo pipefail
          FILE="android/app/build.gradle.kts"
          [ -f "$FILE" ] || (echo "❌ Missing $FILE" && exit 1)

          # ndkVersion
          if grep -q "ndkVersion" "$FILE"; then
            sed -i 's/^[[:space:]]*ndkVersion *=.*/    ndkVersion = "27.0.12077973"/' "$FILE"
          else
            perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
          fi

          # compileSdk = 36
          if grep -qE 'compileSdk\s*=' "$FILE"; then
            sed -i 's/compileSdk\s*=\s*[0-9]\+/compileSdk = 36/g' "$FILE"
          else
            perl -0777 -i -pe 's/android\s*\{\s*/android {\n    compileSdk = 36\n/s' "$FILE"
          fi

          echo "✅ Done:"
          grep -n "ndkVersion\|compileSdk" "$FILE" || true

      # --------------------------------------------
      # Build ci_env.json from runtime-config (by-link)
      # --------------------------------------------
      - name: Build ci_env.json (BY_LINK runtime-config + fallback)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lib/env

          python3 - <<'PY'
          import json, re, os, urllib.request, urllib.error, socket

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api_base = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          link_id  = str(
              cfg.get("OWNER_PROJECT_LINK_ID")
              or payload.get("OWNER_PROJECT_LINK_ID")
              or payload.get("ownerProjectLinkId")
              or cfg.get("ownerProjectLinkId")
              or ""
          ).strip()

          if not api_base:
              raise SystemExit("Missing API_BASE_URL")
          if not link_id:
              raise SystemExit("Missing OWNER_PROJECT_LINK_ID")

          url = f"{api_base}/api/public/runtime-config/by-link?linkId={link_id}"
          runtime = {}
          source = "FALLBACK"

          token = (os.getenv("CI_RUNTIME_TOKEN") or "").strip()
          headers = {"Accept": "application/json"}
          if token:
              headers["X-Auth-Token"] = token

          try:
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=12) as r:
                  runtime = json.loads(r.read().decode("utf-8"))
              source = "BY_LINK"
          except (urllib.error.HTTPError, urllib.error.URLError, socket.timeout, json.JSONDecodeError) as e:
              print("⚠️ runtime-config fetch failed:", repr(e))

          def pick(key, default=None):
              for src in (runtime, cfg, payload):
                  v = src.get(key)
                  if v not in (None, "", []):
                      return v
              return default

          app_name = pick("APP_NAME", "My App")

          pkg_raw = (pick("PACKAGE_NAME") or pick("APPLICATION_ID") or "").strip()
          if not pkg_raw:
              pkg_raw = f"com.build4all.app{link_id}"

          pkg = pkg_raw.lower()
          pkg = re.sub(r"[^a-z0-9._]", "", pkg)
          pkg = re.sub(r"\.+", ".", pkg).strip(".")
          if not pkg or pkg.count(".") < 1:
              pkg = f"com.build4all.app{link_id}"

          vc = pick("ANDROID_VERSION_CODE")
          vn = pick("ANDROID_VERSION_NAME")
          try:
              vc_int = int(vc) if vc not in (None,"",[]) else 1
          except Exception:
              vc_int = 1
          vn_str = (str(vn).strip() if vn not in (None,"",[]) else "1.0.0")

          env = {
              "API_BASE_URL": api_base,
              "APP_NAME": app_name,
              "OWNER_PROJECT_LINK_ID": link_id,
              "PACKAGE_NAME": pkg,
              "ANDROID_VERSION_CODE": vc_int,
              "ANDROID_VERSION_NAME": vn_str,
              "CONFIG_SOURCE": source,
          }

          open("ci_api_base.txt","w",encoding="utf-8").write(api_base)
          open("ci_link_id.txt","w",encoding="utf-8").write(link_id)
          open("ci_package_name.txt","w",encoding="utf-8").write(pkg)
          open("ci_android_version_code.txt","w",encoding="utf-8").write(str(vc_int))
          open("ci_android_version_name.txt","w",encoding="utf-8").write(vn_str)

          os.makedirs("lib/env", exist_ok=True)
          with open("lib/env/ci_env.json","w",encoding="utf-8") as f:
              json.dump(env,f,ensure_ascii=False,indent=2)

          print("✅ PACKAGE_NAME =", pkg)
          print("✅ VERSION_CODE =", vc_int)
          print("✅ VERSION_NAME =", vn_str)
          print("✅ CONFIG_SOURCE =", source)
          PY

      # --------------------------------------------
      # Apply package + namespace + version
      # --------------------------------------------
      - name: Apply PACKAGE_NAME + VERSION (namespace + applicationId)
        shell: bash
        run: |
          set -euo pipefail
          PKG="$(cat ci_package_name.txt | tr -d '\r\n')"
          VC="$(cat ci_android_version_code.txt | tr -d '\r\n')"
          VN="$(cat ci_android_version_name.txt | tr -d '\r\n')"
          FILE="android/app/build.gradle.kts"

          # applicationId
          if grep -qE 'applicationId\s*=\s*"' "$FILE"; then
            sed -i "s/applicationId\s*=\s*\"[^\"]*\"/applicationId = \"$PKG\"/g" "$FILE"
          else
            echo "❌ applicationId not found in build.gradle.kts"; exit 1
          fi

          # namespace
          if grep -qE 'namespace\s*=\s*"' "$FILE"; then
            sed -i "s/namespace\s*=\s*\"[^\"]*\"/namespace = \"$PKG\"/g" "$FILE"
          else
            perl -0777 -i -pe "s/android\\s*\\{\\s*/android {\\n    namespace = \\\"$PKG\\\"\\n/s" "$FILE"
          fi

          # versionCode / versionName
          if grep -qE 'versionCode\s*=' "$FILE"; then
            sed -i "s/versionCode\s*=\s*[0-9]\+/versionCode = $VC/g" "$FILE"
          else
            perl -0777 -i -pe "s/defaultConfig\\s*\\{\\s*/defaultConfig {\\n        versionCode = $VC\\n/s" "$FILE"
          fi

          if grep -qE 'versionName\s*=' "$FILE"; then
            sed -i "s/versionName\s*=\s*\"[^\"]*\"/versionName = \"$VN\"/g" "$FILE"
          else
            perl -0777 -i -pe "s/defaultConfig\\s*\\{\\s*/defaultConfig {\\n        versionName = \\\"$VN\\\"\\n/s" "$FILE"
          fi

          echo "✅ Applied:"
          grep -n "compileSdk\|namespace\|applicationId\|versionCode\|versionName" "$FILE" || true

      # --------------------------------------------
      # Branding (optional) + pub get
      # --------------------------------------------
      - name: Flutter pub get
        run: flutter pub get

      # --------------------------------------------
      # Signing (robust)
      # storeFile must be RELATIVE to android/ folder
      # --------------------------------------------
      - name: Setup Android signing
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android/app

          # decode keystore
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | tr -d '\n\r ' | base64 --decode > android/app/upload-keystore.p12

          # write key.properties in android/
          printf "storeFile=app/upload-keystore.p12\nstorePassword=%s\nkeyAlias=%s\nkeyPassword=%s\n" \
            "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
            "${{ secrets.ANDROID_KEY_ALIAS }}" \
            "${{ secrets.ANDROID_KEY_PASSWORD }}" \
            > android/key.properties

          echo "✅ key.properties:"
          cat android/key.properties | sed 's/storePassword=.*/storePassword=***/; s/keyPassword=.*/keyPassword=***/'

      # --------------------------------------------
      # Build APK + AAB
      # --------------------------------------------
      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # --------------------------------------------
      # Export PACKAGE for later steps
      # --------------------------------------------
      - name: Export packageName
        id: pkg
        shell: bash
        run: |
          PKG="$(cat ci_package_name.txt | tr -d '\r\n')"
          echo "name=$PKG" >> $GITHUB_OUTPUT
          echo "✅ PACKAGE=$PKG"

      # --------------------------------------------
      # Write Play Service Account JSON from B64 secret
      # --------------------------------------------
      - name: Write Play service account json (from B64)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p android/ci
          echo "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON_B64 }}" | tr -d '\n\r ' | base64 --decode > android/ci/play-sa.json

          python3 - <<'PY'
          import json
          j=json.load(open("android/ci/play-sa.json"))
          print("✅ service account:", j.get("client_email"))
          PY

      # --------------------------------------------
      # Upload to Google Play Internal
      # --------------------------------------------
      - name: Upload AAB to Google Play (internal)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: android/ci/play-sa.json
          packageName: ${{ steps.pkg.outputs.name }}
          releaseFiles: build/app/outputs/bundle/release/*.aab
          track: ${{ secrets.PLAY_TRACK || 'internal' }}
          status: completed

      # --------------------------------------------
      # Create GitHub Release (APK + AAB)
      # --------------------------------------------
      - name: Create GitHub Release (APK + AAB)
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          LINK_ID=$(cat ci_link_id.txt | tr -d '\r\n')
          TAG="build-${LINK_ID}-${{ github.run_number }}"

          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --title "$TAG" --notes "CI build"

          gh release upload "$TAG" \
            build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/bundle/release/app-release.aab \
            --clobber

          echo "✅ Release uploaded: $TAG"

      # --------------------------------------------
      # Optional callback (keep yours)
      # --------------------------------------------
      - name: Callback backend (optional)
        shell: bash
        run: |
          set -euo pipefail
          API_BASE="$(cat ci_api_base.txt | tr -d '\r\n')"
          LINK_ID="$(cat ci_link_id.txt | tr -d '\r\n')"
          echo "✅ Callback info API=$API_BASE LINK_ID=$LINK_ID"
          exit 0
