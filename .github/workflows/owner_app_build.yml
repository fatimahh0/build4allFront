name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ✅ Flutter pinned
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: |
          echo '${{ toJson(github.event.client_payload) }}'

      # ✅ Force NDK 27 (SAFE)
      - name: Force Android NDK 27
        run: |
          set -e
          FILE="android/app/build.gradle.kts"

          if [ ! -f "$FILE" ]; then
            echo "android/app/build.gradle.kts not found"
            exit 1
          fi

          if grep -q 'ndkVersion\s*=' "$FILE"; then
            sed -i -E 's/ndkVersion\s*=\s*".*"/ndkVersion = "27.0.12077973"/' "$FILE"
          else
            perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
          fi

          echo "---- ndkVersion ----"
          grep -n "ndkVersion" "$FILE" || true

      # ✅ Fetch build-config from backend (KEYS STAY EXACT) + normalize API_BASE
      - name: Fetch build-config + write ci_env.json
        env:
          CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
        run: |
          set -e
          mkdir -p lib/env

          python3 - <<'PY'
          import json, urllib.request, os

          p = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          runtime = p.get("RUNTIME") or {}

          api_base = (runtime.get("API_BASE_URL") or "").rstrip("/")
          # normalize: if API_BASE_URL mistakenly includes /api, strip it
          if api_base.endswith("/api"):
            api_base = api_base[:-4]

          link_id = str(p.get("OWNER_PROJECT_LINK_ID") or "").strip()

          if not api_base:
            raise SystemExit("Missing RUNTIME.API_BASE_URL in payload")
          if not link_id:
            raise SystemExit("Missing OWNER_PROJECT_LINK_ID in payload")

          # helper files for later steps
          open("ci_api_base.txt","w",encoding="utf-8").write(api_base)
          open("ci_link_id.txt","w",encoding="utf-8").write(link_id)

          token = (os.environ.get("CI_CALLBACK_TOKEN") or "").strip()
          if not token:
            raise SystemExit("Missing CI_CALLBACK_TOKEN secret")

          # ✅ SINGLE SOURCE OF TRUTH
          url = f"{api_base}/api/ci/owner-project-links/{link_id}/build-config"
          req = urllib.request.Request(url, headers={"X-Auth-Token": token})
          with urllib.request.urlopen(req) as r:
            cfg = json.loads(r.read().decode("utf-8"))

          # keep keys EXACT (THEME_JSON_B64, NAV_JSON_B64, ENABLED_FEATURES_JSON_B64, BRANDING_JSON_B64...)
          env = dict(cfg)

          # ensure runtime settings exist (app reads this)
          env.setdefault("RUNTIME", {})
          env["RUNTIME"].setdefault("WS_PATH", runtime.get("WS_PATH") or "/api/ws")
          env["RUNTIME"].setdefault("OWNER_ATTACH_MODE", runtime.get("OWNER_ATTACH_MODE") or "header")
          env["RUNTIME"].setdefault("APP_ROLE", runtime.get("APP_ROLE") or "both")

          with open("lib/env/ci_env.json","w",encoding="utf-8") as f:
            json.dump(env, f, ensure_ascii=False, indent=2)

          print("✅ ci_env.json written from backend build-config")
          print("API_BASE_URL =", api_base)
          print("LINK_ID =", link_id)
          PY

      - name: Flutter pub get
        run: flutter pub get

      # ✅ Branding + strings.xml clean (reads from ci_env.json)
      - name: Apply branding
        run: |
          set -e
          python3 - <<'PY'
          import json, urllib.request, pathlib, shutil
          from xml.sax.saxutils import escape

          cfg = json.load(open("lib/env/ci_env.json","r",encoding="utf-8"))

          app_name_raw = cfg.get("APP_NAME") or "My App"
          app_name = escape(app_name_raw)

          # Branding source priority:
          # 1) BRANDING.logoUrl (if your build-config returns it)
          # 2) APP_LOGO_URL fallback
          branding = cfg.get("BRANDING") or {}
          logo = branding.get("logoUrl") or cfg.get("APP_LOGO_URL") or ""

          pathlib.Path("assets/branding").mkdir(parents=True, exist_ok=True)

          if logo:
            print("Downloading logo:", logo)
            urllib.request.urlretrieve(logo, "assets/branding/logo.png")
            shutil.copyfile("assets/branding/logo.png","assets/branding/launcher.png")
            shutil.copyfile("assets/branding/logo.png","assets/branding/splash.png")
          else:
            print("No logo url in config")

          values_dir = pathlib.Path("android/app/src/main/res/values")
          values_dir.mkdir(parents=True, exist_ok=True)

          strings_xml = (
            '<?xml version="1.0" encoding="utf-8"?>\n'
            '<resources>\n'
            f'  <string name="app_name">{app_name}</string>\n'
            '</resources>\n'
          )
          (values_dir/"strings.xml").write_text(strings_xml, encoding="utf-8")
          print("strings.xml written for:", app_name_raw)
          PY

          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      # ✅ Disable R8 (SAFE)
      - name: Disable R8
        run: |
          set -e
          FILE="android/app/build.gradle.kts"

          if grep -q 'isMinifyEnabled\s*=' "$FILE"; then
            sed -i -E 's/isMinifyEnabled\s*=\s*true/isMinifyEnabled = false/g' "$FILE"
          fi
          if grep -q 'isShrinkResources\s*=' "$FILE"; then
            sed -i -E 's/isShrinkResources\s*=\s*true/isShrinkResources = false/g' "$FILE"
          fi

          if ! grep -q 'isMinifyEnabled\s*=' "$FILE"; then
            perl -0777 -i -pe 's/release\s*\{\s*/release {\n            isMinifyEnabled = false\n            isShrinkResources = false\n/s' "$FILE"
          fi

          echo "---- R8 flags ----"
          grep -n "isMinifyEnabled\|isShrinkResources" "$FILE" || true

      # ✅ Build
      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # ✅ Release + Upload
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          LINK_ID=$(cat ci_link_id.txt)
          TAG="build-${LINK_ID}-${{ github.run_number }}"

          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --title "$TAG" --notes "CI build"

          gh release upload "$TAG" \
            build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/bundle/release/app-release.aab \
            --clobber

          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
          echo "LINK_ID=$LINK_ID" >> $GITHUB_ENV

      # ✅ CALLBACK backend (SAVE URLs) - clean base url, no /api/api, no //
      - name: Callback backend (SAVE URLs)
        run: |
          set -e

          API_BASE=$(cat ci_api_base.txt)
          LINK_ID=$(cat ci_link_id.txt)
          TAG="${RELEASE_TAG}"

          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          APK_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.apk"
          AAB_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.aab"

          echo "API_BASE=$API_BASE"
          echo "LINK_ID=$LINK_ID"
          echo "APK_URL=$APK_URL"
          echo "AAB_URL=$AAB_URL"

          curl -sS -f -X PUT "${API_BASE}/api/ci/owner-project-links/${LINK_ID}/apk-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"apkUrl\":\"${APK_URL}\"}"

          curl -sS -f -X PUT "${API_BASE}/api/ci/owner-project-links/${LINK_ID}/aab-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"aabUrl\":\"${AAB_URL}\"}"
