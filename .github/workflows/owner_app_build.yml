name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Flutter pinned
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: |
          echo '${{ toJson(github.event.client_payload) }}'

      # Force Android NDK 27 (safe replace)
      - name: Force Android NDK 27
        run: |
          set -e
          FILE="android/app/build.gradle.kts"

          if [ -f "$FILE" ]; then
            if grep -q "ndkVersion" "$FILE"; then
              sed -i 's/^[[:space:]]*ndkVersion *=.*/    ndkVersion = "27.0.12077973"/' "$FILE"
            else
              perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
            fi

            echo "---- ndkVersion ----"
            grep -n "ndkVersion" "$FILE" || true
          else
            echo "android/app/build.gradle.kts not found"
            exit 1
          fi

      # ✅ NEW: Fetch runtime config by linkId (source of truth)
      - name: Fetch runtime config by linkId
        run: |
          set -e
          API_BASE="${{ github.event.client_payload.API_BASE_URL }}"
          LINK_ID="${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}"

          if [ -z "$API_BASE" ]; then
            echo "Missing client_payload.API_BASE_URL"
            exit 1
          fi

          if [ -z "$LINK_ID" ]; then
            echo "Missing client_payload.OWNER_PROJECT_LINK_ID"
            exit 1
          fi

          API_BASE="${API_BASE%/}"

          echo "API_BASE=$API_BASE"
          echo "LINK_ID=$LINK_ID"

          curl -sS -f "${API_BASE}/api/public/runtime-config/by-link?linkId=${LINK_ID}" \
            -o runtime_config.json

          echo "---- runtime_config.json ----"
          cat runtime_config.json

          # Save API base + link for later steps (callback + branding)
          echo -n "$API_BASE" > ci_api_base.txt
          echo -n "$LINK_ID" > ci_link_id.txt

      # ✅ Build ci_env.json from runtime_config.json + (optional) PACKAGE_NAME override
      - name: Build ci_env.json + extract CI vars
        run: |
          set -e
          mkdir -p lib/env

          python3 - <<'PY'
          import json, re, os

          # Runtime config fetched from backend
          cfg = json.load(open("runtime_config.json", "r", encoding="utf-8")) or {}

          # From dispatch payload (top-level), not CONFIG
          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}

          api_base = (payload.get("API_BASE_URL") or "").rstrip("/")
          if not api_base:
              raise SystemExit("Missing client_payload.API_BASE_URL")

          link_id = str(payload.get("OWNER_PROJECT_LINK_ID") or "").strip()
          if not link_id:
              # fallback from cfg (should exist anyway)
              link_id = str(cfg.get("OWNER_PROJECT_LINK_ID") or "").strip()
          if not link_id:
              raise SystemExit("Missing OWNER_PROJECT_LINK_ID")

          app_name = (cfg.get("APP_NAME") or "My App")
          app_type = (cfg.get("APP_TYPE") or "ECOMMERCE")
          project_id = str(cfg.get("PROJECT_ID") or "").strip()

          # ✅ PACKAGE_NAME
          # 1) prefer explicit dispatch payload
          pkg = (payload.get("PACKAGE_NAME") or payload.get("APPLICATION_ID") or "").strip()

          # 2) fallback to cfg (if you ever add it later in backend)
          if not pkg:
              pkg = (cfg.get("PACKAGE_NAME") or cfg.get("APPLICATION_ID") or "").strip()

          # 3) fallback deterministic
          if not pkg:
              pkg = f"com.build4all.app{link_id}"

          pkg = pkg.lower()
          pkg = re.sub(r"[^a-z0-9._]", "", pkg)
          if pkg.count(".") < 1:
              pkg = f"com.build4all.{pkg}"

          env = {
              "API_BASE_URL": api_base,
              "APP_NAME": app_name,
              "APP_TYPE": app_type,
              "OWNER_PROJECT_LINK_ID": link_id,
              "PROJECT_ID": project_id,
              "PACKAGE_NAME": pkg,
          }

          # Optional currency (if you later add CURRENCY_ID in backend config)
          currency_id = cfg.get("CURRENCY_ID")
          if currency_id not in (None, "", 0):
              env["CURRENCY_ID"] = str(currency_id)

          # Base64 JSONs (already encoded by backend)
          for key in [
              "THEME_JSON_B64",
              "NAV_JSON_B64",
              "HOME_JSON_B64",
              "ENABLED_FEATURES_JSON_B64",
              "BRANDING_JSON_B64",
          ]:
              v = cfg.get(key)
              if v:
                  env[key] = v

          # LOGO_URL
          logo_url = (cfg.get("LOGO_URL") or cfg.get("LOGO_PATH") or "").strip()
          if logo_url:
              env["LOGO_URL"] = logo_url

          open("ci_package_name.txt", "w", encoding="utf-8").write(pkg)

          with open("lib/env/ci_env.json", "w", encoding="utf-8") as f:
              json.dump(env, f, ensure_ascii=False, indent=2)

          print("ci_env.json written")
          print("API_BASE_URL =", api_base)
          print("OWNER_PROJECT_LINK_ID =", link_id)
          print("PACKAGE_NAME =", pkg)
          print("------ ci_env.json CONTENT ------")
          print(json.dumps(env, ensure_ascii=False, indent=2))
          PY

      # ✅ Apply unique applicationId (PACKAGE_NAME)
      - name: Set unique applicationId (PACKAGE_NAME)
        run: |
          set -e
          FILE="android/app/build.gradle.kts"
          PKG="$(cat ci_package_name.txt | tr -d '\r\n')"

          if [ ! -f "$FILE" ]; then
            echo "android/app/build.gradle.kts not found"
            exit 1
          fi

          echo "Setting applicationId to: $PKG"

          if grep -qE 'applicationId\s*=\s*"' "$FILE"; then
            sed -i "s/applicationId\s*=\s*\"[^\"]*\"/applicationId = \"$PKG\"/g" "$FILE"
          elif grep -qE 'applicationId\s*"' "$FILE"; then
            sed -i "s/applicationId\s*\"[^\"]*\"/applicationId \"$PKG\"/g" "$FILE"
          else
            echo "ERROR: Could not find applicationId in $FILE"
            grep -n "applicationId" "$FILE" || true
            exit 1
          fi

          echo "---- applicationId now ----"
          grep -n "applicationId" "$FILE" || true

      # Branding + strings.xml using LOGO_URL from ci_env.json
      - name: Apply branding
        run: |
          set -e

          python3 - <<'PY'
          import json, urllib.request, pathlib, shutil
          from xml.sax.saxutils import escape

          cfg = json.load(open("lib/env/ci_env.json","r",encoding="utf-8"))

          app_name_raw = cfg.get("APP_NAME","My App")
          app_name = escape(app_name_raw)

          api_base = (cfg.get("API_BASE_URL") or "").rstrip("/")
          logo_url = (cfg.get("LOGO_URL") or "").strip()

          print("APP_NAME:", app_name_raw)
          print("LOGO_URL (raw):", logo_url)
          print("API_BASE_URL:", api_base)

          pathlib.Path("assets/branding").mkdir(parents=True, exist_ok=True)

          # If LOGO_URL is relative, resolve it
          if logo_url and logo_url.startswith("/"):
              if api_base:
                  logo_url = api_base + logo_url
                  print("Resolved absolute LOGO_URL:", logo_url)
              else:
                  print("Relative LOGO_URL but API_BASE_URL missing -> skipping logo download")
                  logo_url = ""

          if logo_url:
              try:
                  print("Downloading logo from:", logo_url)
                  urllib.request.urlretrieve(logo_url, "assets/branding/logo.png")
                  shutil.copyfile("assets/branding/logo.png","assets/branding/launcher.png")
                  shutil.copyfile("assets/branding/logo.png","assets/branding/splash.png")
              except Exception as e:
                  print("⚠️ Failed to download logo:", e)
                  print("Continuing without custom logo...")
          else:
              print("No LOGO_URL – skipping logo download")

          values_dir = pathlib.Path("android/app/src/main/res/values")
          values_dir.mkdir(parents=True, exist_ok=True)

          strings_xml = (
            '<?xml version="1.0" encoding="utf-8"?>\n'
            '<resources>\n'
            f'  <string name="app_name">{app_name}</string>\n'
            '</resources>\n'
          )
          (values_dir/"strings.xml").write_text(strings_xml, encoding="utf-8")
          print("strings.xml written for:", app_name_raw)
          PY

          flutter pub get
          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      # Disable R8
      - name: Disable R8
        run: |
          set -e
          FILE="android/app/build.gradle.kts"

          if grep -q "isMinifyEnabled" "$FILE"; then
            sed -i 's/^[[:space:]]*isMinifyEnabled *=.*/            isMinifyEnabled = false/' "$FILE"
          fi

          if grep -q "isShrinkResources" "$FILE"; then
            sed -i 's/^[[:space:]]*isShrinkResources *=.*/            isShrinkResources = false/' "$FILE"
          fi

          if ! grep -q "isMinifyEnabled" "$FILE"; then
            perl -0777 -i -pe 's/release\s*\{\s*/release {\n            isMinifyEnabled = false\n            isShrinkResources = false\n/s' "$FILE"
          fi

          echo "---- R8 flags ----"
          grep -n "isMinifyEnabled\|isShrinkResources" "$FILE" || true

      # Build
      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # Release + Upload
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          LINK_ID=$(cat ci_link_id.txt)
          TAG="build-${LINK_ID}-${{ github.run_number }}"

          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --title "$TAG" --notes "CI build"

          gh release upload "$TAG" \
            build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/bundle/release/app-release.aab \
            --clobber

          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
          echo "LINK_ID=$LINK_ID" >> $GITHUB_ENV

      # CALLBACK (uses API_BASE_URL + X-Auth-Token)
      - name: Callback backend (SAVE URLs)
        run: |
          set -e

          API_BASE=$(cat ci_api_base.txt)
          LINK_ID=$(cat ci_link_id.txt)
          TAG="${RELEASE_TAG}"

          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          APK_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.apk"
          AAB_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.aab"

          echo "API_BASE=$API_BASE"
          echo "LINK_ID=$LINK_ID"
          echo "APK_URL=$APK_URL"
          echo "AAB_URL=$AAB_URL"

          curl -sS -f -X PUT "${API_BASE}/api/ci/owner-project-links/${LINK_ID}/apk-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"apkUrl\":\"${APK_URL}\"}"

          curl -sS -f -X PUT "${API_BASE}/api/ci/owner-project-links/${LINK_ID}/aab-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"aabUrl\":\"${AAB_URL}\"}"
