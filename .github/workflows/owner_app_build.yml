name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (Android)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ✅ FIX 1: Pin Flutter version
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: |
          echo '${{ toJson(github.event.client_payload) }}'

      # ✅ FIX 2: NDK 27 required by plugins
      - name: Force Android NDK 27 everywhere
        run: |
          set -e
          echo "---- Searching ndkVersion ----"
          grep -R "ndkVersion" -n android/app || true

          if [ -f "android/app/build.gradle.kts" ]; then
            FILE="android/app/build.gradle.kts"
            echo "Patching $FILE"

            if grep -q 'ndkVersion' "$FILE"; then
              sed -i 's/ndkVersion *= *.*/ndkVersion = "27.0.12077973"/' "$FILE"
            else
              perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
            fi

            echo "---- Result ----"
            grep -n "ndkVersion" "$FILE" || true
          fi

          if [ -f "android/app/build.gradle" ]; then
            FILE="android/app/build.gradle"
            echo "Patching $FILE"

            if grep -q 'ndkVersion' "$FILE"; then
              sed -i 's/ndkVersion .*/ndkVersion "27.0.12077973"/' "$FILE"
            else
              perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion "27.0.12077973"\n/s' "$FILE"
            fi

            echo "---- Result ----"
            grep -n "ndkVersion" "$FILE" || true
          fi

      - name: Build env json from payload (lib/env/ci_env.json)
        run: |
          mkdir -p lib/env
          python3 - <<'PY'
          import json, base64

          p = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}

          runtime = p.get("RUNTIME") or {}
          api_base = (runtime.get("API_BASE_URL") or "").rstrip("/")
          ws_path = runtime.get("WS_PATH") or "/api/ws"
          owner_attach_mode = runtime.get("OWNER_ATTACH_MODE") or "header"
          app_role = runtime.get("APP_ROLE") or "both"

          link_id = str(p.get("OWNER_PROJECT_LINK_ID") or "")
          project_id = str(p.get("PROJECT_ID") or "")

          app = p.get("APP") or {}
          app_name = app.get("APP_NAME") or "My App"
          slug = app.get("SLUG") or "app"

          currency_id = app.get("CURRENCY_ID")
          currency_id_str = str(currency_id) if currency_id is not None and str(currency_id).strip() != "" else None

          theme_json = app.get("APP_THEME_JSON") or "{}"
          theme_b64 = base64.b64encode(theme_json.encode("utf-8")).decode("utf-8")

          env = {
            "API_BASE_URL": api_base,
            "APP_NAME": app_name,
            "APP_TYPE": p.get("APP_TYPE") or "ECOMMERCE",
            "OWNER_PROJECT_LINK_ID": link_id,
            "PROJECT_ID": project_id,
            "CURRENCY_ID": currency_id_str,
            "THEME_JSON_B64": theme_b64,
            "BRANDING": {
              "logoUrl": app.get("APP_LOGO_URL") or "",
              "splashColor": "#FFFFFF"
            },
            "RUNTIME": {
              "WS_PATH": ws_path,
              "OWNER_ATTACH_MODE": owner_attach_mode,
              "APP_ROLE": app_role
            }
          }

          env = {k:v for k,v in env.items() if v is not None}

          out = "lib/env/ci_env.json"
          with open(out, "w", encoding="utf-8") as f:
            json.dump(env, f, ensure_ascii=False, indent=2)

          print("Wrote", out)
          print("APP_NAME =", env.get("APP_NAME"))
          print("CURRENCY_ID =", env.get("CURRENCY_ID"))
          PY

      - name: Flutter pub get
        run: flutter pub get

      # ✅ FIX 3: Branding + strings.xml rewritten cleanly
      - name: Apply branding (CI)
        run: |
          python3 - <<'PY'
          import json, urllib.request, pathlib, shutil
          from xml.sax.saxutils import escape

          cfg = json.load(open("lib/env/ci_env.json","r",encoding="utf-8"))
          app_name_raw = cfg.get("APP_NAME","My App")
          app_name = escape(app_name_raw)

          branding = cfg.get("BRANDING", {})
          logo_url = branding.get("logoUrl","")

          pathlib.Path("assets/branding").mkdir(parents=True, exist_ok=True)

          if logo_url:
            print("Downloading logo:", logo_url)
            urllib.request.urlretrieve(logo_url, "assets/branding/logo.png")
            shutil.copyfile("assets/branding/logo.png", "assets/branding/launcher.png")
            shutil.copyfile("assets/branding/logo.png", "assets/branding/splash.png")
          else:
            print("No logoUrl provided, skipping logo download")

          strings_path = pathlib.Path("android/app/src/main/res/values/strings.xml")
          strings_path.parent.mkdir(parents=True, exist_ok=True)

          content = (
            '<?xml version="1.0" encoding="utf-8"?>\n'
            '<resources>\n'
            f'  <string name="app_name">{app_name}</string>\n'
            '</resources>\n'
          )
          strings_path.write_text(content, encoding="utf-8")

          print("Branding applied. app_name =", app_name_raw)
          print("---- strings.xml ----")
          print(strings_path.read_text(encoding="utf-8"))
          PY

          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      - name: Verify Android resources (app_name must exist)
        run: |
          echo "---- AndroidManifest label ----"
          grep -n "android:label" android/app/src/main/AndroidManifest.xml || true

          echo "---- strings.xml ----"
          cat android/app/src/main/res/values/strings.xml

          echo "---- Verify app_name exists ----"
          grep -n 'name="app_name"' android/app/src/main/res/values/strings.xml

      # ✅ FIX 4: Disable R8 minify for release
      - name: Disable R8 minify for release (CI fix)
        run: |
          set -e
          FILE="android/app/build.gradle.kts"

          if [ -f "$FILE" ]; then
            echo "Patching $FILE to disable R8"

            if grep -q "isMinifyEnabled" "$FILE"; then
              sed -i 's/isMinifyEnabled *= *.*/isMinifyEnabled = false/' "$FILE"
            else
              perl -0777 -i -pe 's/release\s*\{\s*/release {\n            isMinifyEnabled = false\n            isShrinkResources = false\n/s' "$FILE"
            fi

            if grep -q "isShrinkResources" "$FILE"; then
              sed -i 's/isShrinkResources *= *.*/isShrinkResources = false/' "$FILE"
            fi

            echo "---- Confirm release config ----"
            grep -n "isMinifyEnabled\|isShrinkResources" "$FILE" || true
          else
            echo "android/app/build.gradle.kts not found!"
            exit 1
          fi

      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # ✅ Output paths
      - name: Prepare output paths
        id: out
        run: |
          echo "APK=build/app/outputs/flutter-apk/app-release.apk" >> $GITHUB_OUTPUT
          echo "AAB=build/app/outputs/bundle/release/app-release.aab" >> $GITHUB_OUTPUT

      # ✅ Keep artifacts inside Actions too (optional)
      - name: Upload artifacts to Actions
        uses: actions/upload-artifact@v4
        with:
          name: android-build-${{ github.event.client_payload.APP.SLUG || github.event.client_payload.SLUG }}
          path: |
            ${{ steps.out.outputs.APK }}
            ${{ steps.out.outputs.AAB }}

      # ✅ Create Release + upload APK/AAB (this makes public URLs that work)
      - name: Create Release + upload APK/AAB
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          LINK_ID="${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}"
          RUN="${{ github.run_number }}"
          TAG="build-${LINK_ID}-${RUN}"

          echo "TAG=$TAG"

          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" \
              --title "Build ${TAG}" \
              --notes "CI build for ownerProjectLinkId=${LINK_ID}"

          gh release upload "$TAG" \
            "${{ steps.out.outputs.APK }}#app-release.apk" \
            "${{ steps.out.outputs.AAB }}#app-release.aab" \
            --clobber

          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      # ✅ Callback backend to save URLs into DB
      - name: Callback backend with APK/AAB urls
        run: |
          set -e

          TAG="${RELEASE_TAG}"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          APK_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.apk"
          AAB_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.aab"

          CALLBACK_BASE="${{ github.event.client_payload.CALLBACK_BASE || '' }}"
          if [ -z "$CALLBACK_BASE" ]; then
            CALLBACK_BASE="http://3.96.140.126:8080/api/ci"
          fi

          LINK_ID="${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}"

          echo "APK_URL=$APK_URL"
          echo "AAB_URL=$AAB_URL"
          echo "CALLBACK_BASE=$CALLBACK_BASE"
          echo "LINK_ID=$LINK_ID"

          curl -f -X PUT "${CALLBACK_BASE}/owner-project-links/${LINK_ID}/apk-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"apkUrl\":\"${APK_URL}\"}"

          curl -f -X PUT "${CALLBACK_BASE}/owner-project-links/${LINK_ID}/aab-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"aabUrl\":\"${AAB_URL}\"}"
