name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # ✅ Flutter pinned
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: echo '${{ toJson(github.event.client_payload) }}'

      # ✅ Force NDK 27
      - name: Force Android NDK 27
        run: |
          set -e
          FILE="android/app/build.gradle.kts"
          if [ -f "$FILE" ]; then
            if grep -q "ndkVersion" "$FILE"; then
              sed -i 's/ndkVersion *= *.*/ndkVersion = "27.0.12077973"/' "$FILE"
            else
              perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
            fi
          fi
          grep -n "ndkVersion" "$FILE" || true

      # ✅ Build env
      - name: Build ci_env.json
        run: |
          mkdir -p lib/env
          python3 - <<'PY'
          import json, base64
          p = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}

          runtime = p.get("RUNTIME") or {}
          app = p.get("APP") or {}

          env = {
            "API_BASE_URL": (runtime.get("API_BASE_URL") or "").rstrip("/"),
            "APP_NAME": app.get("APP_NAME") or "My App",
            "APP_TYPE": p.get("APP_TYPE") or "ECOMMERCE",
            "OWNER_PROJECT_LINK_ID": str(p.get("OWNER_PROJECT_LINK_ID") or ""),
            "PROJECT_ID": str(p.get("PROJECT_ID") or ""),
            "CURRENCY_ID": str(app.get("CURRENCY_ID")) if app.get("CURRENCY_ID") is not None else None,
            "THEME_JSON_B64": base64.b64encode((app.get("APP_THEME_JSON") or "{}").encode()).decode(),
            "BRANDING": {
              "logoUrl": app.get("APP_LOGO_URL") or "",
              "splashColor": "#FFFFFF"
            },
            "RUNTIME": {
              "WS_PATH": runtime.get("WS_PATH") or "/api/ws",
              "OWNER_ATTACH_MODE": runtime.get("OWNER_ATTACH_MODE") or "header",
              "APP_ROLE": runtime.get("APP_ROLE") or "both"
            }
          }

          env = {k:v for k,v in env.items() if v is not None}

          with open("lib/env/ci_env.json","w",encoding="utf-8") as f:
            json.dump(env,f,indent=2)

          print("ci_env.json written")
          PY

      - name: Flutter pub get
        run: flutter pub get

      # ✅ Branding + strings.xml clean
      - name: Apply branding
        run: |
          python3 - <<'PY'
          import json, urllib.request, pathlib, shutil
          from xml.sax.saxutils import escape

          cfg = json.load(open("lib/env/ci_env.json"))
          app_name = escape(cfg.get("APP_NAME","My App"))
          logo = cfg.get("BRANDING",{}).get("logoUrl","")

          pathlib.Path("assets/branding").mkdir(parents=True, exist_ok=True)

          if logo:
            urllib.request.urlretrieve(logo, "assets/branding/logo.png")
            shutil.copy("assets/branding/logo.png","assets/branding/launcher.png")
            shutil.copy("assets/branding/logo.png","assets/branding/splash.png")

          p = pathlib.Path("android/app/src/main/res/values")
          p.mkdir(parents=True, exist_ok=True)
          (p/"strings.xml").write_text(
            '<?xml version="1.0" encoding="utf-8"?>\n'
            '<resources>\n'
            f'  <string name="app_name">{app_name}</string>\n'
            '</resources>\n',
            encoding="utf-8"
          )
          PY

          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      # ✅ Disable R8 (Stripe fix)
      - name: Disable R8
        run: |
          FILE="android/app/build.gradle.kts"
          perl -0777 -i -pe 's/release\s*\{\s*/release {\n            isMinifyEnabled = false\n            isShrinkResources = false\n/s' "$FILE"
          grep -n "isMinifyEnabled" "$FILE"

      # ✅ Build
      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # ✅ Release + Upload
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e
          LINK_ID="${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}"
          TAG="build-${LINK_ID}-${{ github.run_number }}"

          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --title "$TAG" --notes "CI build"

          gh release upload "$TAG" \
            build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/bundle/release/app-release.aab \
            --clobber

          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      # ✅ CALLBACK (FIXED AUTH)
      - name: Callback backend (SAVE URLs)
        run: |
          set -e
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          TAG="${RELEASE_TAG}"
          LINK_ID="${{ github.event.client_payload.OWNER_PROJECT_LINK_ID }}"

          APK_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.apk"
          AAB_URL="https://github.com/${OWNER}/${REPO}/releases/download/${TAG}/app-release.aab"

          echo "APK_URL=$APK_URL"
          echo "AAB_URL=$AAB_URL"

          curl -f -X PUT "http://3.96.140.126:8080/api/ci/owner-project-links/${LINK_ID}/apk-url" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CI_CALLBACK_TOKEN}" \
            -d "{\"apkUrl\":\"${APK_URL}\"}"

          curl -f -X PUT "http://3.96.140.126:8080/api/ci/owner-project-links/${LINK_ID}/aab-url" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${CI_CALLBACK_TOKEN}" \
            -d "{\"aabUrl\":\"${AAB_URL}\"}"
