name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

    steps:
      # ════════════════════════════════════════════════════════════════════
      # CHECKOUT / TOOLING
      # ════════════════════════════════════════════════════════════════════
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        shell: bash
        run: |
          set -euo pipefail
          flutter --version
          dart --version

      - name: Show payload (debug)
        shell: bash
        run: |
          set -euo pipefail
          echo '${{ toJson(github.event.client_payload) }}'

      # ════════════════════════════════════════════════════════════════════
      # Ensure branding folder
      # ════════════════════════════════════════════════════════════════════
      - name: Ensure branding folder exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p assets/branding

      # ════════════════════════════════════════════════════════════════════
      # compileSdk / targetSdk
      # ════════════════════════════════════════════════════════════════════
      - name: Force compileSdk/targetSdk 36
        shell: bash
        run: |
          set -euo pipefail
          FILE="android/app/build.gradle.kts"

          sed -i 's/compileSdk\s*=.*/compileSdk = 36/' "$FILE" || true
          sed -i 's/targetSdk\s*=.*/targetSdk = 36/' "$FILE" || true

      # ════════════════════════════════════════════════════════════════════
      # NDK
      # ════════════════════════════════════════════════════════════════════
      - name: Force Android NDK 27
        shell: bash
        run: |
          set -euo pipefail
          sed -i 's/ndkVersion\s*=.*/ndkVersion = "27.0.12077973"/' android/app/build.gradle.kts || true

      # ════════════════════════════════════════════════════════════════════
      # BUILD ci_env.json  ✅ VERSION FIX HERE
      # ════════════════════════════════════════════════════════════════════
      - name: Build ci_env.json
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lib/env

          python3 - <<'PY'
          import json, re, os

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api_base = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          link_id = str(
              cfg.get("OWNER_PROJECT_LINK_ID")
              or payload.get("OWNER_PROJECT_LINK_ID")
              or payload.get("ownerProjectLinkId")
              or ""
          ).strip()

          if not api_base or not link_id:
              raise SystemExit("Missing API_BASE_URL or OWNER_PROJECT_LINK_ID")

          pkg = (
              cfg.get("androidPackageName")
              or payload.get("androidPackageName")
              or f"com.build4all.app{link_id}"
          ).lower()

          vc = (
              cfg.get("androidVersionCode")
              or payload.get("androidVersionCode")
          )

          vn = (
              cfg.get("androidVersionName")
              or payload.get("androidVersionName")
              or "1.0.0"
          )

          run_number = int(os.getenv("GITHUB_RUN_NUMBER", "1"))

          try:
              backend_vc = int(vc) if vc else 0
          except:
              backend_vc = 0

          vc_int = max(backend_vc, run_number)

          env = {
              "API_BASE_URL": api_base,
              "OWNER_PROJECT_LINK_ID": link_id,
              "PACKAGE_NAME": pkg,
              "ANDROID_VERSION_CODE": vc_int,
              "ANDROID_VERSION_NAME": vn
          }

          open("ci_package_name.txt","w").write(pkg)
          open("ci_android_version_code.txt","w").write(str(vc_int))
          open("ci_android_version_name.txt","w").write(vn)
          open("ci_link_id.txt","w").write(link_id)
          open("ci_api_base.txt","w").write(api_base)

          with open("lib/env/ci_env.json","w") as f:
              json.dump(env, f, indent=2)

          print("versionCode =", vc_int)
          print("versionName =", vn)
          PY

      # ════════════════════════════════════════════════════════════════════
      # Apply version to Gradle
      # ════════════════════════════════════════════════════════════════════
      - name: Apply version
        run: |
          VC=$(cat ci_android_version_code.txt)
          VN=$(cat ci_android_version_name.txt)
          sed -i "s/versionCode\s*=.*/versionCode = $VC/" android/app/build.gradle.kts
          sed -i "s/versionName\s*=.*/versionName = \"$VN\"/" android/app/build.gradle.kts

      # ════════════════════════════════════════════════════════════════════
      # BUILD
      # ════════════════════════════════════════════════════════════════════
      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # ════════════════════════════════════════════════════════════════════
      # UPLOAD TO PLAY CONSOLE
      # ════════════════════════════════════════════════════════════════════
      - name: Upload AAB to Google Play (internal)
        run: |
          echo "${{ secrets.PLAY_SERVICE_ACCOUNT_JSON_B64 }}" | base64 --decode > play-sa.json
          fastlane supply \
            --json_key play-sa.json \
            --package_name "$(cat ci_package_name.txt)" \
            --aab build/app/outputs/bundle/release/app-release.aab \
            --track internal \
            --skip_upload_metadata true \
            --skip_upload_images true \
            --skip_upload_screenshots true
