name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java (Android)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter (stable)
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: |
          echo '${{ toJson(github.event.client_payload) }}'

      # ✅ NDK FIX (bulletproof)
      - name: Force Android NDK 27 everywhere
        run: |
          echo "---- Listing gradle files ----"
          ls -la android/app || true
          echo "---- Searching for ndkVersion ----"
          grep -R "ndkVersion" -n android/app || true

          if [ -f "android/app/build.gradle.kts" ]; then
            FILE="android/app/build.gradle.kts"
            echo "Patching $FILE"
            if grep -q "ndkVersion" "$FILE"; then
              sed -i 's/ndkVersion = ".*"/ndkVersion = "27.0.12077973"/' "$FILE"
            else
              perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
            fi
            grep -n "ndkVersion" "$FILE" || true
          fi

          if [ -f "android/app/build.gradle" ]; then
            FILE="android/app/build.gradle"
            echo "Patching $FILE"
            if grep -q "ndkVersion" "$FILE"; then
              sed -i 's/ndkVersion .*/ndkVersion "27.0.12077973"/' "$FILE"
            else
              perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion "27.0.12077973"\n/s' "$FILE"
            fi
            grep -n "ndkVersion" "$FILE" || true
          fi

      - name: Build env json from payload (lib/env/ci_env.json)
        run: |
          mkdir -p lib/env
          python3 - <<'PY'
          import json, base64
          p = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}

          runtime = p.get("RUNTIME") or {}
          api_base = (runtime.get("API_BASE_URL") or "").rstrip("/")
          ws_path = runtime.get("WS_PATH") or "/api/ws"
          owner_attach_mode = runtime.get("OWNER_ATTACH_MODE") or "header"
          app_role = runtime.get("APP_ROLE") or "both"

          owner_id = str(p.get("OWNER_ID") or "")
          project_id = str(p.get("PROJECT_ID") or "")
          link_id = str(p.get("OWNER_PROJECT_LINK_ID") or "")

          # your payload uses APP object
          app = p.get("APP") or {}
          app_name = app.get("APP_NAME") or "My App"
          slug = app.get("SLUG") or "app"

          currency_id = app.get("CURRENCY_ID")
          currency_id_str = str(currency_id) if currency_id is not None and str(currency_id).strip() != "" else None

          theme_json = app.get("APP_THEME_JSON") or "{}"
          theme_b64 = base64.b64encode(theme_json.encode("utf-8")).decode("utf-8")

          env = {
            "API_BASE_URL": api_base,
            "APP_NAME": app_name,
            "APP_TYPE": p.get("APP_TYPE") or "ECOMMERCE",
            "OWNER_PROJECT_LINK_ID": link_id,
            "PROJECT_ID": project_id,
            "CURRENCY_ID": currency_id_str,
            "THEME_JSON_B64": theme_b64,
            "BRANDING": {
              "logoUrl": app.get("APP_LOGO_URL") or "",
              "splashColor": "#FFFFFF"
            },
            "RUNTIME": {
              "WS_PATH": ws_path,
              "OWNER_ATTACH_MODE": owner_attach_mode,
              "APP_ROLE": app_role
            }
          }

          env = {k:v for k,v in env.items() if v is not None}

          out = "lib/env/ci_env.json"
          with open(out, "w", encoding="utf-8") as f:
            json.dump(env, f, ensure_ascii=False, indent=2)

          print("Wrote", out)
          print("APP_NAME =", env.get("APP_NAME"))
          print("CURRENCY_ID =", env.get("CURRENCY_ID"))
          PY

      - name: Flutter pub get
        run: flutter pub get

      - name: Apply branding (CI)
        run: |
          python3 - <<'PY'
          import json, urllib.request, pathlib, re, shutil

          cfg = json.load(open("lib/env/ci_env.json","r",encoding="utf-8"))
          app_name = cfg.get("APP_NAME","My App")
          branding = cfg.get("BRANDING", {})
          logo_url = branding.get("logoUrl","")

          pathlib.Path("assets/branding").mkdir(parents=True, exist_ok=True)

          if logo_url:
            print("Downloading logo:", logo_url)
            urllib.request.urlretrieve(logo_url, "assets/branding/logo.png")
            shutil.copyfile("assets/branding/logo.png", "assets/branding/launcher.png")
            shutil.copyfile("assets/branding/logo.png", "assets/branding/splash.png")
          else:
            print("No logoUrl provided, skipping logo download")

          # create/update strings.xml
          strings_path = pathlib.Path("android/app/src/main/res/values/strings.xml")
          strings_path.parent.mkdir(parents=True, exist_ok=True)

          s = f'<resources>\\n  <string name="app_name">{app_name}</string>\\n</resources>\\n'
          strings_path.write_text(s, encoding="utf-8")

          print("Branding applied. app_name =", app_name)
          print("---- strings.xml ----")
          print(strings_path.read_text(encoding="utf-8"))
          PY

          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      # ✅ app_name MUST exist before build (hard verify)
      - name: Verify Android resources (app_name must exist)
        run: |
          echo "---- AndroidManifest label line ----"
          grep -n "android:label" -n android/app/src/main/AndroidManifest.xml || true

          echo "---- strings.xml paths ----"
          find android/app/src/main/res -maxdepth 3 -type f -name "strings.xml" -print || true

          echo "---- strings.xml content ----"
          cat android/app/src/main/res/values/strings.xml

          echo "---- Check resource name exists ----"
          grep -R "name=\"app_name\"" -n android/app/src/main/res/values/strings.xml

      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json
