name: Owner App Build (APK + AAB)

on:
  repository_dispatch:
    types: [owner_app_build]

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

    steps:
      # ─────────────────────────────────────────────
      # Checkout & tooling
      # ─────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: echo '${{ toJson(github.event.client_payload) }}'

      # ─────────────────────────────────────────────
      # Android NDK
      # ─────────────────────────────────────────────
      - name: Force Android NDK 27
        run: |
          FILE="android/app/build.gradle.kts"
          if grep -q "ndkVersion" "$FILE"; then
            sed -i 's/ndkVersion *=.*/ndkVersion = "27.0.12077973"/' "$FILE"
          else
            perl -0777 -i -pe 's/android\s*\{\s*/android {\n    ndkVersion = "27.0.12077973"\n/s' "$FILE"
          fi

      # ─────────────────────────────────────────────
      # Build ci_env.json (UNCHANGED LOGIC)
      # ─────────────────────────────────────────────
      - name: Build ci_env.json
        run: |
          mkdir -p lib/env
          python3 - <<'PY'
          import json, re, os
          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          link = str(
            cfg.get("OWNER_PROJECT_LINK_ID")
            or payload.get("OWNER_PROJECT_LINK_ID")
            or payload.get("ownerProjectLinkId")
            or ""
          ).strip()

          if not api or not link:
              raise SystemExit("Missing API_BASE_URL or OWNER_PROJECT_LINK_ID")

          pkg = (
            cfg.get("androidPackageName")
            or payload.get("androidPackageName")
            or f"com.build4all.app{link}"
          ).lower()

          pkg = re.sub(r"[^a-z0-9._]", "", pkg)

          vc = cfg.get("androidVersionCode") or payload.get("androidVersionCode") or 1
          vn = cfg.get("androidVersionName") or payload.get("androidVersionName") or "1.0.0"

          env = {
            "API_BASE_URL": api,
            "OWNER_PROJECT_LINK_ID": link,
            "PACKAGE_NAME": pkg,
            "ANDROID_VERSION_CODE": int(vc),
            "ANDROID_VERSION_NAME": vn,
          }

          open("ci_api_base.txt","w").write(api)
          open("ci_link_id.txt","w").write(link)
          open("ci_package_name.txt","w").write(pkg)
          open("ci_android_version_code.txt","w").write(str(vc))
          open("ci_android_version_name.txt","w").write(vn)

          with open("lib/env/ci_env.json","w") as f:
              json.dump(env,f,indent=2)
          PY

      # ─────────────────────────────────────────────
      # Apply package + version
      # ─────────────────────────────────────────────
      - name: Apply package & version
        run: |
          FILE="android/app/build.gradle.kts"
          PKG=$(cat ci_package_name.txt)
          VC=$(cat ci_android_version_code.txt)
          VN=$(cat ci_android_version_name.txt)

          sed -i "s/applicationId *=.*/applicationId = \"$PKG\"/" $FILE || true
          sed -i "s/namespace *=.*/namespace = \"$PKG\"/" $FILE || true
          sed -i "s/versionCode *=.*/versionCode = $VC/" $FILE
          sed -i "s/versionName *=.*/versionName = \"$VN\"/" $FILE

      # ─────────────────────────────────────────────
      # Branding
      # ─────────────────────────────────────────────
      - name: Apply branding
        run: |
          python3 - <<'PY'
          import json, pathlib
          cfg=json.load(open("lib/env/ci_env.json"))
          name=cfg.get("APP_NAME","My App")
          values=pathlib.Path("android/app/src/main/res/values")
          values.mkdir(parents=True,exist_ok=True)
          (values/"strings.xml").write_text(
            f'<?xml version="1.0" encoding="utf-8"?><resources><string name="app_name">{name}</string></resources>'
          )
          PY
          flutter pub get
          flutter pub run flutter_launcher_icons || true
          flutter pub run flutter_native_splash:create || true

      # ─────────────────────────────────────────────
      # ✅ FIXED SIGNING (THE IMPORTANT PART)
      # ─────────────────────────────────────────────
      - name: Setup Android signing (FIXED)
        run: |
          set -e
          mkdir -p android/app

          # decode keystore
          echo "${{ secrets.ANDROID_KEYSTORE_B64 }}" | base64 --decode > android/app/upload-keystore.jks

          # key.properties MUST be under android/
          cat > android/key.properties <<EOF
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          storeFile=app/upload-keystore.jks
          EOF

          echo "Signing files:"
          ls -la android/app
          cat android/key.properties | sed 's/Password=.*/Password=***/g'

      # ─────────────────────────────────────────────
      # Build
      # ─────────────────────────────────────────────
      - name: Build APK
        run: flutter build apk --release --dart-define-from-file=lib/env/ci_env.json

      - name: Build AAB
        run: flutter build appbundle --release --dart-define-from-file=lib/env/ci_env.json

      # ─────────────────────────────────────────────
      # GitHub Release
      # ─────────────────────────────────────────────
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LINK=$(cat ci_link_id.txt)
          TAG="build-${LINK}-${{ github.run_number }}"
          gh release view "$TAG" >/dev/null 2>&1 || gh release create "$TAG"
          gh release upload "$TAG" \
            build/app/outputs/flutter-apk/app-release.apk \
            build/app/outputs/bundle/release/app-release.aab \
            --clobber
          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV

      # ─────────────────────────────────────────────
      # Callback backend
      # ─────────────────────────────────────────────
      - name: Callback backend
        run: |
          API=$(cat ci_api_base.txt)
          LINK=$(cat ci_link_id.txt)
          TAG="$RELEASE_TAG"

          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          APK="https://github.com/$OWNER/$REPO/releases/download/$TAG/app-release.apk"
          AAB="https://github.com/$OWNER/$REPO/releases/download/$TAG/app-release.aab"

          curl -X PUT "$API/api/ci/owner-project-links/$LINK/apk-url" \
            -H "X-Auth-Token: $CI_CALLBACK_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"apkUrl\":\"$APK\"}" || true

          curl -X PUT "$API/api/ci/owner-project-links/$LINK/aab-url" \
            -H "X-Auth-Token: $CI_CALLBACK_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"aabUrl\":\"$AAB\"}" || true
