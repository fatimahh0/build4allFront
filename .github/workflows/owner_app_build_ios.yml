name: Owner App Build (iOS IPA)

on:
  repository_dispatch:
    types: [owner_app_build_ios]

permissions:
  contents: read

jobs:
  build-ios:
    runs-on: macos-14

    env:
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}

      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_P8_B64: ${{ secrets.ASC_KEY_P8_B64 }}

      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
    # --------------------------------------------------
    # CHECKOUT
    # --------------------------------------------------
    - name: Checkout
      uses: actions/checkout@v4

    # --------------------------------------------------
    # XCODE
    # --------------------------------------------------
    - name: Select Xcode
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        xcodebuild -version

    # --------------------------------------------------
    # FLUTTER
    # --------------------------------------------------
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: "3.32.0"
        channel: stable
        cache: true

    - name: Flutter pub get
      run: flutter pub get

    # --------------------------------------------------
    # BUILD ci_env.json + READ BUNDLE ID
    # --------------------------------------------------
    - name: Build ci_env.json & read bundle id
      run: |
        mkdir -p lib/env
        python3 - <<'PY'
        import json, os
        payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''')
        ios_bundle = payload.get("iosBundleId")
        if not ios_bundle:
            raise SystemExit("Missing iosBundleId")
        open("ci_ios_bundle_id.txt","w").write(ios_bundle)
        json.dump({}, open("lib/env/ci_env.json","w"))
        print("IOS_BUNDLE_ID =", ios_bundle)
        PY

    # --------------------------------------------------
    # iOS PLATFORM
    # --------------------------------------------------
    - name: Ensure iOS platform
      run: |
        if [ ! -f ios/Podfile ]; then
          flutter create .
        fi

    # --------------------------------------------------
    # RUBY + FASTLANE
    # --------------------------------------------------
    - uses: ruby/setup-ruby@v1
      with:
        ruby-version: "3.2"

    - name: Install Fastlane
      run: gem install fastlane -N

    # --------------------------------------------------
    # APP STORE CONNECT API KEY
    # --------------------------------------------------
    - name: Create App Store Connect API key
      run: |
        mkdir -p .private
        echo "${ASC_KEY_P8_B64}" | base64 --decode > .private/AuthKey_${ASC_KEY_ID}.p8
        export ASC_KEY_PATH="$GITHUB_WORKSPACE/.private/AuthKey_${ASC_KEY_ID}.p8"
        echo "ASC_KEY_PATH=$ASC_KEY_PATH" >> $GITHUB_ENV

    # --------------------------------------------------
    # BUILD IPA (FASTLANE â€” CLEAN)
    # --------------------------------------------------
    - name: Build IPA (Clean & Stable)
      run: |
        cd ios
        fastlane build_appstore \
          bundle_id:"$(cat ../ci_ios_bundle_id.txt)"

    # --------------------------------------------------
    # ARTIFACT
    # --------------------------------------------------
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: ios-ipa
        path: build/ios/ipa/app.ipa
