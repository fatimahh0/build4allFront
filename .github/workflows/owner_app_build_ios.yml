name: Owner App Build (iOS IPA)

on:
  repository_dispatch:
    types: [owner_app_build_ios]

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-14

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

      # Signing certificate (.p12) — Apple Distribution (must include private key)
      IOS_P12_B64: ${{ secrets.IOS_P12_B64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }} # e.g. 7LL4J6N52N

      # For TestFlight/App Store
      IOS_EXPORT_METHOD: app-store

      # App Store Connect API Key (Automation)
      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_P8_B64: ${{ secrets.ASC_KEY_P8_B64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Install fastlane + cocoapods
        shell: bash
        run: |
          set -euo pipefail
          sudo gem install fastlane -N
          sudo gem install cocoapods -N || true

      - name: Show Flutter/Dart versions
        shell: bash
        run: |
          set -euo pipefail
          flutter --version
          dart --version

      - name: Show payload (debug)
        shell: bash
        run: |
          set -euo pipefail
          echo '${{ toJson(github.event.client_payload) }}'

      # ---------------- YOUR ci_env.json STEP (unchanged) ----------------
      - name: Build ci_env.json (BY_LINK runtime-config + fallback)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lib/env
          python3 - <<'PY'
          import json, os, urllib.request, urllib.error, socket

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api_base = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          link_id  = str(
              cfg.get("OWNER_PROJECT_LINK_ID")
              or payload.get("OWNER_PROJECT_LINK_ID")
              or payload.get("ownerProjectLinkId")
              or cfg.get("ownerProjectLinkId")
              or ""
          ).strip()

          if not api_base:
              raise SystemExit("Missing API_BASE_URL")
          if not link_id:
              raise SystemExit("Missing OWNER_PROJECT_LINK_ID")

          url = f"{api_base}/api/public/runtime-config/by-link?linkId={link_id}"
          runtime = {}
          source = "FALLBACK"

          token = (os.getenv("CI_RUNTIME_TOKEN") or "").strip()
          headers = {"Accept": "application/json"}
          if token:
              headers["X-Auth-Token"] = token

          try:
              print("Fetching runtime config:", url)
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=12) as r:
                  runtime = json.loads(r.read().decode("utf-8"))
              source = "BY_LINK"
          except (urllib.error.HTTPError, urllib.error.URLError, socket.timeout, json.JSONDecodeError) as e:
              print("⚠️ runtime-config fetch failed, using fallback:", repr(e))

          def pick(key, default=None):
              v = runtime.get(key)
              if v not in (None, "", []):
                  return v
              v = cfg.get(key)
              if v not in (None, "", []):
                  return v
              v = payload.get(key)
              if v not in (None, "", []):
                  return v
              return default

          env = {
              "API_BASE_URL": api_base,
              "APP_NAME": pick("APP_NAME", "My App"),
              "APP_TYPE": pick("APP_TYPE", "ECOMMERCE"),
              "OWNER_PROJECT_LINK_ID": link_id,
              "PROJECT_ID": str(pick("PROJECT_ID", "")).strip(),
              "CONFIG_SOURCE": source,
          }

          for key in ["THEME_JSON_B64","NAV_JSON_B64","HOME_JSON_B64","ENABLED_FEATURES_JSON_B64","BRANDING_JSON_B64"]:
              v = pick(key)
              if v:
                  env[key] = v

          ios_bundle = (
              runtime.get("iosBundleId")
              or runtime.get("IOS_BUNDLE_ID")
              or cfg.get("iosBundleId")
              or cfg.get("IOS_BUNDLE_ID")
              or payload.get("iosBundleId")
              or payload.get("IOS_BUNDLE_ID")
          )
          if ios_bundle:
              ios_bundle = str(ios_bundle).strip()
              open("ci_ios_bundle_id.txt", "w", encoding="utf-8").write(ios_bundle)
              print("IOS_BUNDLE_ID =", ios_bundle)
          else:
              # allow wildcard template; we will generate explicit later
              open("ci_ios_bundle_id.txt", "w", encoding="utf-8").write("com.build4all.*")
              print("IOS_BUNDLE_ID = com.build4all.* (template)")
          
          with open("lib/env/ci_env.json", "w", encoding="utf-8") as f:
              json.dump(env, f, ensure_ascii=False, indent=2)
          PY

      # ---------------- MAKE BUNDLE ID EXPLICIT (opl37) ----------------
      - name: Generate explicit Bundle ID (com.build4all.oplXX.app)
        shell: bash
        run: |
          set -euo pipefail
          RAW="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"

          # Your app code (you said: opl37). If later you pass it in payload, replace this line.
          CODE="opl37"

          if [[ -z "$RAW" || "$RAW" == *"*"* ]]; then
            BUNDLE_ID="com.build4all.${CODE}.app"
          else
            BUNDLE_ID="$RAW"
          fi

          echo "$BUNDLE_ID" > ci_ios_bundle_id.txt
          echo "✅ IOS_BUNDLE_ID = $BUNDLE_ID"

      - name: Apply branding (icons + splash)
        shell: bash
        run: |
          set -euo pipefail
          flutter pub get
          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      - name: Patch iOS bundle id + team in pbxproj
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"
          TEAM="${IOS_TEAM_ID}"
          PBX="ios/Runner.xcodeproj/project.pbxproj"

          perl -pi -e "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]+;/PRODUCT_BUNDLE_IDENTIFIER = ${BUNDLE_ID};/g" "$PBX"
          perl -pi -e "s/DEVELOPMENT_TEAM = [A-Z0-9]+;/DEVELOPMENT_TEAM = ${TEAM};/g" "$PBX"

      # ---------------- CERTIFICATE / KEYCHAIN ----------------
      - name: Setup iOS cert (keychain)
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${IOS_P12_B64:-}" ] || { echo "❌ Missing IOS_P12_B64"; exit 1; }
          [ -n "${IOS_P12_PASSWORD:-}" ] || { echo "❌ Missing IOS_P12_PASSWORD"; exit 1; }

          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"

          security create-keychain -p "" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "" "$KEYCHAIN_PATH"

          echo "$IOS_P12_B64" | tr -d '\n\r ' | base64 --decode > ios_cert.p12

          security import ios_cert.p12 -k "$KEYCHAIN_PATH" -P "$IOS_P12_PASSWORD" -A \
            -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcodebuild

          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" "$KEYCHAIN_PATH"

          echo "---- identities (build.keychain) ----"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true

          CNT=$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep -c "\"")
          if [ "$CNT" -lt 1 ]; then
            echo "❌ No signing identity found in keychain. Your .p12 likely has no private key."
            exit 1
          fi

      - name: DEBUG signing identities (after import)
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"
          echo "---- list keychains ----"
          security list-keychains -d user
          echo "---- default keychain ----"
          security default-keychain -d user
          echo "---- identities (build.keychain) ----"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH" || true
          echo "---- identities (login keychain) ----"
          security find-identity -v -p codesigning login.keychain-db || true

      # ---------------- AUTO CREATE APP + PROFILE (FASTLANE) ----------------
      - name: Create App Store Connect app + download App Store profile (fastlane)
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"
          APP_NAME="$(python3 -c "import json; print(json.load(open('lib/env/ci_env.json'))['APP_NAME'])" | tr -d '\r\n')"

          mkdir -p fastlane_keys fastlane
          echo "$ASC_KEY_P8_B64" | tr -d '\n\r ' | base64 --decode > fastlane_keys/AuthKey.p8

          cat > fastlane/Fastfile <<'RUBY'
          default_platform(:ios)

          platform :ios do
            lane :ensure_app_and_profile do |options|
              bundle_id = options[:bundle_id]
              app_name  = options[:app_name]
              team_id   = options[:team_id]

              api_key = app_store_connect_api_key(
                key_id: ENV["ASC_KEY_ID"],
                issuer_id: ENV["ASC_ISSUER_ID"],
                key_filepath: "fastlane_keys/AuthKey.p8"
              )

              # Create App Store Connect app + register explicit App ID in Dev Portal
              produce(
                app_identifier: bundle_id,
                app_name: app_name,
                team_id: team_id,
                api_key: api_key,
                skip_itc: false,
                skip_devcenter: false
              )

              # Download/create App Store provisioning profile
              sigh(
                app_identifier: bundle_id,
                adhoc: false,
                development: false,
                skip_install: true,
                api_key: api_key
              )
            end
          end
          RUBY

          fastlane ios ensure_app_and_profile bundle_id:"$BUNDLE_ID" app_name:"$APP_NAME" team_id:"$IOS_TEAM_ID"

          PROFILE_FILE="$(ls -t *.mobileprovision 2>/dev/null | head -n 1 || true)"
          if [ -z "$PROFILE_FILE" ]; then
            echo "❌ fastlane did not produce a .mobileprovision file in workspace."
            exit 1
          fi

          echo "Using profile file: $PROFILE_FILE"
          /usr/bin/security cms -D -i "$PROFILE_FILE" > profile.plist

          PROFILE_NAME="$("/usr/libexec/PlistBuddy" -c "Print :Name" profile.plist)"
          PROFILE_UUID="$("/usr/libexec/PlistBuddy" -c "Print :UUID" profile.plist)"

          echo "$PROFILE_NAME" > ci_profile_name.txt
          echo "$PROFILE_UUID" > ci_profile_uuid.txt

          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"
          cp "$PROFILE_FILE" "$HOME/Library/MobileDevice/Provisioning Profiles/${PROFILE_UUID}.mobileprovision"

          echo "✅ Installed profile: $PROFILE_NAME (UUID=$PROFILE_UUID)"

      # ---------------- FORCE MANUAL SIGNING (DISTRIBUTION) ----------------
      - name: Force Manual Signing in Xcode project (distribution + profile)
        shell: bash
        run: |
          set -euo pipefail

          PBX="ios/Runner.xcodeproj/project.pbxproj"
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"
          TEAM="${IOS_TEAM_ID}"
          PROFILE_NAME="$(cat ci_profile_name.txt | tr -d '\r\n')"
          PROFILE_UUID="$(cat ci_profile_uuid.txt | tr -d '\r\n')"

          perl -pi -e 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$PBX"
          perl -pi -e "s/DEVELOPMENT_TEAM = [A-Z0-9]+;/DEVELOPMENT_TEAM = ${TEAM};/g" "$PBX"

          perl -pi -e "s/PROVISIONING_PROFILE_SPECIFIER = [^;]*;/PROVISIONING_PROFILE_SPECIFIER = ${PROFILE_NAME};/g" "$PBX"
          perl -pi -e "s/PROVISIONING_PROFILE = [^;]*;/PROVISIONING_PROFILE = ${PROFILE_UUID};/g" "$PBX"

          # Force Distribution identity (prevents "No development certificates" errors)
          perl -pi -e 's/CODE_SIGN_IDENTITY = ".*?";/CODE_SIGN_IDENTITY = "Apple Distribution";/g' "$PBX"
          perl -pi -e 's/"CODE_SIGN_IDENTITY\\[sdk=iphoneos\\*\\]" = ".*?";/"CODE_SIGN_IDENTITY[sdk=iphoneos*]" = "Apple Distribution";/g' "$PBX"

          perl -pi -e "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]+;/PRODUCT_BUNDLE_IDENTIFIER = ${BUNDLE_ID};/g" "$PBX"

      # ---------------- EXPORT OPTIONS ----------------
      - name: Create ExportOptions.plist
        shell: bash
        run: |
          set -euo pipefail
          METHOD="${IOS_EXPORT_METHOD}"
          TEAM="${IOS_TEAM_ID}"
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"
          PROFILE_NAME="$(cat ci_profile_name.txt | tr -d '\r\n')"

          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${METHOD}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${TEAM}</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>destination</key>
            <string>export</string>
          </dict>
          </plist>
          EOF

      - name: Install CocoaPods (ios/)
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          pod repo update
          pod install

      - name: HARD CHECK right before build
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"
          security find-identity -v -p codesigning "$KEYCHAIN_PATH"

      # ---------------- BUILD ----------------
      - name: Build iOS IPA (signed)
        shell: bash
        env:
          OTHER_CODE_SIGN_FLAGS: "--keychain ${{ github.workspace }}/build.keychain"
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"

          security unlock-keychain -p "" "$KEYCHAIN_PATH" || true
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -s "$KEYCHAIN_PATH"

          flutter pub get
          echo "➡️ Building IPA (signed)."
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define-from-file=lib/env/ci_env.json

      - name: List build outputs (debug)
        shell: bash
        run: |
          set -euo pipefail
          ls -la build/ios/ipa || true
          ls -la build/ios/archive || true
          ls -la build/ios || true
