name: Owner App Build (iOS IPA)

on:
  repository_dispatch:
    types: [owner_app_build_ios]

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

      # iOS signing secrets
      IOS_P12_B64: ${{ secrets.IOS_P12_B64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }} # app-store | ad-hoc | development | enterprise

      # Provisioning profile source:
      IOS_MOBILEPROVISION_B64: ${{ secrets.IOS_MOBILEPROVISION_B64 }}

      # Backend path base (used for per-owner fetch)
      IOS_PROFILE_ENDPOINT_PATH: /api/ci/owner-project-links

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Show Flutter/Dart versions
        run: |
          flutter --version
          dart --version

      - name: Show payload (debug)
        run: |
          echo '${{ toJson(github.event.client_payload) }}'

      # Build ci_env.json from payload/runtime-config and extract iosBundleId -> ci_ios_bundle_id.txt
      - name: Build ci_env.json (BY_LINK runtime-config + fallback)
        run: |
          set -e
          mkdir -p lib/env

          python3 - <<'PY'
          import json, os, urllib.request, urllib.error, socket

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api_base = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          link_id  = str(
              cfg.get("OWNER_PROJECT_LINK_ID")
              or payload.get("OWNER_PROJECT_LINK_ID")
              or payload.get("ownerProjectLinkId")
              or cfg.get("ownerProjectLinkId")
              or ""
          ).strip()

          if not api_base:
              raise SystemExit("Missing API_BASE_URL")
          if not link_id:
              raise SystemExit("Missing OWNER_PROJECT_LINK_ID")

          url = f"{api_base}/api/public/runtime-config/by-link?linkId={link_id}"
          runtime = {}
          source = "FALLBACK"

          token = (os.getenv("CI_RUNTIME_TOKEN") or "").strip()
          headers = {"Accept": "application/json"}
          if token:
              headers["X-Auth-Token"] = token

          try:
              print("Fetching runtime config:", url)
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=12) as r:
                  runtime = json.loads(r.read().decode("utf-8"))
              source = "BY_LINK"
          except (urllib.error.HTTPError, urllib.error.URLError, socket.timeout, json.JSONDecodeError) as e:
              print("⚠️ runtime-config fetch failed, using fallback:", repr(e))

          def pick(key, default=None):
              v = runtime.get(key)
              if v not in (None, "", []):
                  return v
              v = cfg.get(key)
              if v not in (None, "", []):
                  return v
              v = payload.get(key)
              if v not in (None, "", []):
                  return v
              return default

          env = {
              "API_BASE_URL": api_base,
              "APP_NAME": pick("APP_NAME", "My App"),
              "APP_TYPE": pick("APP_TYPE", "ECOMMERCE"),
              "OWNER_PROJECT_LINK_ID": link_id,
              "PROJECT_ID": str(pick("PROJECT_ID", "")).strip(),
              "CONFIG_SOURCE": source,
          }

          currency_id = pick("CURRENCY_ID") or runtime.get("currencyId") or cfg.get("currencyId") or payload.get("currencyId")
          if currency_id not in (None, "", []):
              env["CURRENCY_ID"] = str(currency_id).strip()

          for key in ["THEME_JSON_B64","NAV_JSON_B64","HOME_JSON_B64","ENABLED_FEATURES_JSON_B64","BRANDING_JSON_B64"]:
              v = pick(key)
              if v:
                  env[key] = v

          logo_url = (pick("LOGO_URL") or pick("LOGO_PATH") or runtime.get("logoUrl") or "").strip()
          if logo_url:
              env["LOGO_URL"] = logo_url

          ios_bundle = (
              runtime.get("iosBundleId")
              or runtime.get("IOS_BUNDLE_ID")
              or cfg.get("iosBundleId")
              or cfg.get("IOS_BUNDLE_ID")
              or payload.get("iosBundleId")
              or payload.get("IOS_BUNDLE_ID")
          )
          if ios_bundle:
              open("ci_ios_bundle_id.txt", "w", encoding="utf-8").write(str(ios_bundle).strip())
              print("IOS_BUNDLE_ID =", ios_bundle)
          else:
              raise SystemExit("Missing IOS_BUNDLE_ID (runtime-config must provide iosBundleId)")

          os.makedirs("lib/env", exist_ok=True)
          with open("lib/env/ci_env.json", "w", encoding="utf-8") as f:
              json.dump(env, f, ensure_ascii=False, indent=2)

          open("ci_api_base.txt", "w", encoding="utf-8").write(api_base)
          open("ci_link_id.txt", "w", encoding="utf-8").write(link_id)

          print("✅ ci_env.json written. source=", source)
          print("API_BASE_URL =", api_base)
          print("OWNER_PROJECT_LINK_ID =", link_id)
          print("CURRENCY_ID =", env.get("CURRENCY_ID"))
          PY

      - name: Debug ci_env.json
        run: |
          echo "----- ci_env.json -----"
          cat lib/env/ci_env.json
          echo "----- ios bundle id -----"
          cat ci_ios_bundle_id.txt

      - name: Apply branding (icons + splash)
        run: |
          set -e
          flutter pub get
          flutter pub run flutter_launcher_icons
          flutter pub run flutter_native_splash:create

      # Patch bundle id in Xcode project (multi-app)
      - name: Patch iOS bundle id from DB (ci_ios_bundle_id.txt)
        run: |
          set -e
          BUNDLE_ID=$(cat ci_ios_bundle_id.txt | tr -d '\r\n')
          echo "✅ Using iOS bundle id: $BUNDLE_ID"

          PBX="ios/Runner.xcodeproj/project.pbxproj"
          if [ ! -f "$PBX" ]; then
            echo "❌ Missing $PBX"
            exit 1
          fi

          perl -pi -e "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]+;/PRODUCT_BUNDLE_IDENTIFIER = $BUNDLE_ID;/g" "$PBX"
          grep -n "PRODUCT_BUNDLE_IDENTIFIER" "$PBX" | head -n 30

      # Setup signing certificate in a custom keychain (FIXED)
      - name: Setup iOS cert (keychain) - FIXED
        run: |
          set -e
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain

          echo "$IOS_P12_B64" | base64 --decode > ios_cert.p12

          # ✅ IMPORTANT: -A so xcodebuild can use it
          security import ios_cert.p12 -k build.keychain -P "$IOS_P12_PASSWORD" -A

          # ✅ Make sure this keychain is searched/default
          security list-keychains -d user -s build.keychain
          security default-keychain -s build.keychain

          # ✅ Allow Apple tools to access private key in CI
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain

          echo "✅ Certificate imported into keychain."

      # Verify the identity exists (critical debug)
      - name: Verify codesign identity exists
        run: |
          set -e
          echo "---- identities in build.keychain ----"
          security find-identity -v -p codesigning build.keychain || true
          echo "---- identities overall ----"
          security find-identity -v -p codesigning || true

      # (Optional) Fetch provisioning profile per owner from backend
      - name: Fetch provisioning profile per owner (optional)
        run: |
          set -e
          API_BASE="$(cat ci_api_base.txt | tr -d '\r\n')"
          LINK_ID="$(cat ci_link_id.txt | tr -d '\r\n')"

          PROFILE_URL="${API_BASE}${IOS_PROFILE_ENDPOINT_PATH}/${LINK_ID}/ios-profile"
          echo "Fetching profile from: $PROFILE_URL"

          HTTP=$(curl -sS -o ios_profile.json -w "%{http_code}" \
            -H "Accept: application/json" \
            -H "X-Auth-Token: ${CI_RUNTIME_TOKEN}" \
            "$PROFILE_URL" || true)

          echo "HTTP_STATUS=$HTTP"
          cat ios_profile.json || true

          if [ "$HTTP" -ge 400 ]; then
            echo "⚠️ Could not fetch per-owner profile. Will fallback to IOS_MOBILEPROVISION_B64 if provided."
            exit 0
          fi

          python3 - <<'PY'
          import json, base64
          d=json.load(open("ios_profile.json","r",encoding="utf-8"))
          b64=d.get("mobileprovisionB64") or d.get("IOS_MOBILEPROVISION_B64") or ""
          if not b64:
              raise SystemExit("No mobileprovisionB64 in response")
          open("profile.mobileprovision","wb").write(base64.b64decode(b64))
          print("✅ profile.mobileprovision written from backend response")
          PY

      # Fallback provisioning profile from secret
      - name: Provisioning profile fallback from secret
        run: |
          set -e
          if [ -f profile.mobileprovision ]; then
            echo "✅ profile.mobileprovision already present (fetched)."
            exit 0
          fi

          if [ -z "${IOS_MOBILEPROVISION_B64}" ]; then
            echo "❌ Missing IOS_MOBILEPROVISION_B64 and no fetched profile.mobileprovision."
            exit 1
          fi

          echo "$IOS_MOBILEPROVISION_B64" | base64 --decode > profile.mobileprovision
          echo "✅ profile.mobileprovision written from secret."

      # Install provisioning profile by UUID (FIXED)
      - name: Install provisioning profile (UUID-based) - FIXED
        run: |
          set -e
          mkdir -p "$HOME/Library/MobileDevice/Provisioning Profiles"

          if [ ! -s profile.mobileprovision ]; then
            echo "❌ profile.mobileprovision missing/empty"
            exit 1
          fi

          UUID=$(/usr/bin/security cms -D -i profile.mobileprovision \
            | /usr/libexec/PlistBuddy -c 'Print :UUID' /dev/stdin)

          cp profile.mobileprovision "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

          echo "✅ Installed provisioning profile UUID=$UUID"
          ls -la "$HOME/Library/MobileDevice/Provisioning Profiles/$UUID.mobileprovision"

      # Create ExportOptions.plist (dynamic provisioningProfiles mapping) - FIXED
      - name: Create ExportOptions.plist (dynamic) - FIXED
        run: |
          set -e
          METHOD="${IOS_EXPORT_METHOD:-app-store}"
          TEAM="${IOS_TEAM_ID}"
          BUNDLE_ID=$(cat ci_ios_bundle_id.txt | tr -d '\r\n')

          /usr/bin/security cms -D -i profile.mobileprovision > profile.plist
          PROFILE_NAME=$(/usr/libexec/PlistBuddy -c "Print :Name" profile.plist)

          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${METHOD}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${TEAM}</string>

            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>

            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>destination</key>
            <string>export</string>
          </dict>
          </plist>
          EOF

          echo "---- ExportOptions.plist ----"
          cat ios/ExportOptions.plist

      # CocoaPods (recommended)
      - name: Install CocoaPods
        run: |
          set -e
          sudo gem install cocoapods -N || true
          cd ios
          pod repo update
          pod install

      # Build IPA
      - name: Build iOS IPA (signed)
        run: |
          set -e
          flutter pub get
          echo "➡️ Building IPA (signed)."
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define-from-file=lib/env/ci_env.json

      - name: List build outputs (debug)
        run: |
          echo "---- IPA folder ----"
          ls -la build/ios/ipa || true
          echo "---- Archive folder ----"
          ls -la build/ios/archive || true
          echo "---- iOS build dir ----"
          ls -la build/ios || true

      - name: Create GitHub Release + upload IPA
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -e

          if ! ls build/ios/ipa/*.ipa >/dev/null 2>&1; then
            echo "❌ No IPA produced."
            exit 1
          fi

          LINK_ID=$(cat ci_link_id.txt | tr -d '\r\n')
          TAG="ios-build-${LINK_ID}-${{ github.run_number }}"

          gh release view "$TAG" >/dev/null 2>&1 || \
            gh release create "$TAG" --title "$TAG" --notes "iOS CI build"

          gh release upload "$TAG" build/ios/ipa/*.ipa --clobber

          echo "RELEASE_TAG=$TAG" >> $GITHUB_ENV
          echo "LINK_ID=$LINK_ID" >> $GITHUB_ENV

      - name: Callback backend (SAVE IPA URL) (non-blocking)
        run: |
          set -e

          if [ -z "${RELEASE_TAG}" ]; then
            echo "⚠️ No release tag => no IPA => skipping callback."
            exit 0
          fi

          API_BASE="$(cat ci_api_base.txt | tr -d '\r\n')"
          LINK_ID="$(cat ci_link_id.txt | tr -d '\r\n')"
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"

          IPA_NAME=$(ls build/ios/ipa/*.ipa | xargs -n 1 basename | head -n 1)
          IPA_URL="https://github.com/${OWNER}/${REPO}/releases/download/${RELEASE_TAG}/${IPA_NAME}"

          echo "✅ IPA URL: $IPA_URL"

          HTTP=$(curl -sS -o ipa_resp.txt -w "%{http_code}" -X PUT \
            "${API_BASE}/api/ci/owner-project-links/${LINK_ID}/ipa-url" \
            -H "Content-Type: application/json" \
            -H "X-Auth-Token: ${CI_CALLBACK_TOKEN}" \
            -d "{\"ipaUrl\":\"${IPA_URL}\"}" || true)

          echo "HTTP_STATUS=$HTTP"
          cat ipa_resp.txt || true

          if [ "$HTTP" -ge 400 ]; then
            echo "⚠️ Callback failed, but build is still valid."
            exit 0
          fi

          echo "✅ Callback succeeded."
