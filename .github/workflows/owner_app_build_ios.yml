name: Owner App Build (iOS IPA) — Option A (Clean & Stable)

on:
  repository_dispatch:
    types: [owner_app_build_ios]

permissions:
  contents: read

jobs:
  build-ios:
    runs-on: macos-14

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

      IOS_P12_B64: ${{ secrets.IOS_P12_B64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }} # app-store

      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_P8_B64: ${{ secrets.ASC_KEY_P8_B64 }}

      SPACESHIP_CONNECT_API_IN_HOUSE: "false"
      COCOAPODS_DISABLE_STATS: "true"
      FASTLANE_OPT_OUT_USAGE: "true"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      # --------------------------------------------------
      # CHECKOUT + TOOLCHAIN
      # --------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      - name: Select Xcode (prefer 15.3)
        shell: bash
        run: |
          set -euo pipefail
          ls -la /Applications | grep Xcode || true

          if [ -d "/Applications/Xcode_15.3.app" ]; then
            sudo xcode-select -s /Applications/Xcode_15.3.app/Contents/Developer
          else
            sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          fi

          xcodebuild -version



      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Flutter pub get
        shell: bash
        run: |
          set -euo pipefail
          flutter --version
          flutter pub get

      - name: Show dispatch payload (debug)
        shell: bash
        run: |
          set -euo pipefail
          echo '${{ toJson(github.event.client_payload) }}'

      # --------------------------------------------------
      # Build ci_env.json & read iosBundleId (stable)
      # --------------------------------------------------
      - name: Build ci_env.json & read bundle id
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lib/env

          python3 - <<'PY'
          import json, os, urllib.request
          from urllib.parse import urljoin

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api_base = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          if not api_base:
              raise SystemExit("Missing API_BASE_URL")

          link_id = str(
              cfg.get("OWNER_PROJECT_LINK_ID")
              or payload.get("OWNER_PROJECT_LINK_ID")
              or payload.get("ownerProjectLinkId")
              or cfg.get("ownerProjectLinkId")
              or ""
          ).strip()
          if not link_id:
              raise SystemExit("Missing OWNER_PROJECT_LINK_ID / ownerProjectLinkId")

          def pick(d, *keys):
              if not isinstance(d, dict):
                  return None
              for k in keys:
                  v = d.get(k)
                  if v not in (None, "", [], {}):
                      return v
              return None

          token = (os.getenv("CI_RUNTIME_TOKEN") or "").strip()
          headers = {"Accept": "application/json"}
          if token:
              headers["X-Auth-Token"] = token

          def http_get_json(url: str):
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=25) as r:
                  return json.loads(r.read().decode("utf-8"))

          ios_bundle = pick(payload, "iosBundleId", "IOS_BUNDLE_ID") or pick(cfg, "iosBundleId", "IOS_BUNDLE_ID")
          source = "PAYLOAD"

          runtime_url = pick(payload, "runtimeConfigUrl") or pick(cfg, "runtimeConfigUrl")
          if not ios_bundle and runtime_url:
              full_url = runtime_url
              if runtime_url.startswith("/"):
                  full_url = urljoin(api_base + "/", runtime_url.lstrip("/"))
              elif not runtime_url.startswith("http"):
                  full_url = urljoin(api_base + "/", runtime_url)
              runtime = http_get_json(full_url)
              ios_bundle = pick(runtime, "iosBundleId", "IOS_BUNDLE_ID")
              source = "RUNTIME_CONFIG_URL"

          if not ios_bundle:
              by_link = f"{api_base}/api/public/runtime-config/by-link?linkId={link_id}"
              runtime = http_get_json(by_link)
              ios_bundle = pick(runtime, "iosBundleId", "IOS_BUNDLE_ID")
              source = "BY_LINK"

          if not ios_bundle:
              raise SystemExit("Missing iosBundleId from payload/runtimeConfigUrl/by-link")

          ios_bundle = str(ios_bundle).strip()
          open("ci_ios_bundle_id.txt", "w", encoding="utf-8").write(ios_bundle)
          print(f"IOS_BUNDLE_ID = {ios_bundle} (source={source})")

          env = {
              "API_BASE_URL": api_base,
              "APP_NAME": pick(payload, "appName") or pick(cfg, "APP_NAME") or "My App",
              "OWNER_PROJECT_LINK_ID": link_id,
              "CONFIG_SOURCE": source,
          }

          for key in ["THEME_JSON_B64","NAV_JSON_B64","HOME_JSON_B64","ENABLED_FEATURES_JSON_B64","BRANDING_JSON_B64"]:
              v = pick(payload, key) or pick(cfg, key)
              if v:
                  env[key] = v

          with open("lib/env/ci_env.json", "w", encoding="utf-8") as f:
              json.dump(env, f, ensure_ascii=False, indent=2)
          PY

      - name: Read App Store Connect app metadata (name/sku/locale) from payload
        shell: bash
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import json, os
          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          def pick(*keys):
            for k in keys:
              if k in payload and payload[k]:
                return payload[k]
              if k in cfg and cfg[k]:
                return cfg[k]
            return ""

          app_name = pick("APPLE_APP_NAME","appleAppName","appStoreAppName","ASC_APP_NAME")
          sku      = pick("APPLE_SKU","appleSku","appStoreSku","ASC_SKU")
          locale   = pick("APPLE_PRIMARY_LOCALE","applePrimaryLocale","primaryLocale","ASC_PRIMARY_LOCALE") or "en-US"

          # Write to GITHUB_ENV so next steps see them
          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as f:
            f.write(f"APPLE_APP_NAME={app_name}\n")
            f.write(f"APPLE_SKU={sku}\n")
            f.write(f"APPLE_PRIMARY_LOCALE={locale}\n")

          print("APPLE_APP_NAME=", app_name)
          print("APPLE_SKU=", sku)
          print("APPLE_PRIMARY_LOCALE=", locale)
          PY


      # --------------------------------------------------
      # Ensure iOS folder exists
      # --------------------------------------------------
      - name: Ensure iOS Podfile exists
        shell: bash
        run: |
          set -euo pipefail
          if [ ! -f "ios/Podfile" ]; then
            flutter create .
          fi
          test -f ios/Podfile

      # --------------------------------------------------
      # CERTIFICATE IMPORT (P12) in isolated keychain
      # --------------------------------------------------
      - name: Setup iOS signing certificate (keychain)
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${IOS_P12_B64:-}" ] || { echo "❌ Missing IOS_P12_B64"; exit 1; }
          [ -n "${IOS_P12_PASSWORD:-}" ] || { echo "❌ Missing IOS_P12_PASSWORD"; exit 1; }

          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"
          KEYCHAIN_PWD="ci_keychain_pwd_123"

          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"

          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -s "$KEYCHAIN_PATH"

          echo "$IOS_P12_B64" | tr -d '\n\r ' | base64 --decode > ios_cert.p12
          security import ios_cert.p12 -k "$KEYCHAIN_PATH" -P "$IOS_P12_PASSWORD" -A \
            -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcodebuild

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"

          echo "---- identities ----"
          security find-identity -v -p codesigning || true

          CNT=$(security find-identity -v -p codesigning | grep -c "Apple Distribution" || true)
          if [ "$CNT" -lt 1 ]; then
            echo "❌ Apple Distribution identity not found."
            exit 1
          fi

      # --------------------------------------------------
      # RUBY + COCOAPODS + FASTLANE
      # --------------------------------------------------
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install CocoaPods + fastlane
        shell: bash
        run: |
          set -euo pipefail
          gem install cocoapods -N
          gem install fastlane -N
          pod --version
          fastlane --version
          
      - name: Clean Pods (force regen)
        shell: bash
        run: |
          set -euo pipefail
          rm -rf ios/Pods
          rm -f ios/Podfile.lock
    
      - name: Install iOS Pods
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          pod install || { pod repo update; pod install; }

      # --------------------------------------------------
      # APP STORE CONNECT API KEY (fastlane)
      # --------------------------------------------------
      - name: Create App Store Connect api_key.json
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .private

          [ -n "${ASC_KEY_ID:-}" ] || { echo "❌ ASC_KEY_ID empty"; exit 1; }
          [ -n "${ASC_ISSUER_ID:-}" ] || { echo "❌ ASC_ISSUER_ID empty"; exit 1; }
          [ -n "${ASC_KEY_P8_B64:-}" ] || { echo "❌ ASC_KEY_P8_B64 empty"; exit 1; }

          echo "${ASC_KEY_P8_B64}" | tr -d '\n\r ' | base64 --decode > .private/AuthKey_${ASC_KEY_ID}.p8
          openssl pkey -in .private/AuthKey_${ASC_KEY_ID}.p8 -noout >/dev/null

          python3 - <<'PY'
          import json, pathlib, os
          p8 = pathlib.Path(f".private/AuthKey_{os.environ['ASC_KEY_ID']}.p8").read_text()
          pathlib.Path(".private/api_key.json").write_text(json.dumps({
            "key_id": os.environ["ASC_KEY_ID"].strip(),
            "issuer_id": os.environ["ASC_ISSUER_ID"].strip(),
            "key": p8,
            "in_house": False
          }))
          PY

      # --------------------------------------------------
      # Provisioning: App ID + Profile
      # --------------------------------------------------
      - name: Ensure App ID exists on Apple Developer (produce)
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"

          fastlane run produce \
            app_identifier:"$BUNDLE_ID" \
            team_id:"${IOS_TEAM_ID}" \
            api_key_path:"$GITHUB_WORKSPACE/.private/api_key.json" \
            skip_itc:true \
            language:en \
            app_name:"Runner" || true

      - name: Get App Store provisioning profile (sigh)
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"

          fastlane run get_provisioning_profile \
            app_identifier:"$BUNDLE_ID" \
            team_id:"${IOS_TEAM_ID}" \
            api_key_path:"$GITHUB_WORKSPACE/.private/api_key.json" \
            provisioning_name:"B4A_${BUNDLE_ID}_APPSTORE" \
            readonly:false

      - name: Detect installed provisioning profile (name)
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"
          APP_ID="${IOS_TEAM_ID}.${BUNDLE_ID}"

          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILES_DIR"

          FOUND_NAME=""
          for f in "$PROFILES_DIR"/*.mobileprovision; do
            [ -f "$f" ] || continue
            TMP_PLIST="$(mktemp /tmp/profile.XXXXXX.plist)"
            /usr/bin/security cms -D -i "$f" > "$TMP_PLIST"

            P_APPID=$("/usr/libexec/PlistBuddy" -c "Print :Entitlements:application-identifier" "$TMP_PLIST" 2>/dev/null || true)
            if [ "$P_APPID" = "$APP_ID" ]; then
              FOUND_NAME=$("/usr/libexec/PlistBuddy" -c "Print :Name" "$TMP_PLIST" 2>/dev/null || true)
              echo "$FOUND_NAME" > ci_profile_name.txt
              echo "✅ Profile matched: $FOUND_NAME ($P_APPID)"
              rm -f "$TMP_PLIST"
              break
            fi
            rm -f "$TMP_PLIST"
          done
          [ -n "$FOUND_NAME" ] || { echo "❌ No profile matched $APP_ID"; exit 1; }

      - name: Create ExportOptions.plist (manual + provisioningProfiles)
        shell: bash
        run: |
          set -euo pipefail

          METHOD="${IOS_EXPORT_METHOD:-app-store}"
          TEAM="${IOS_TEAM_ID}"
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"
          PROFILE_NAME="$(tr -d '\r\n' < ci_profile_name.txt)"

          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${METHOD}</string>

            <key>signingStyle</key>
            <string>manual</string>

            <key>teamID</key>
            <string>${TEAM}</string>

            <key>signingCertificate</key>
            <string>Apple Distribution</string>

            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>

            <key>destination</key>
            <string>export</string>

            <key>compileBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          /usr/bin/plutil -lint ios/ExportOptions.plist
          echo "✅ ExportOptions.plist ready for ${BUNDLE_ID} using ${PROFILE_NAME}"

      - name: Patch Runner signing (Release only) + Bundle ID
        shell: bash
        run: |
          set -euo pipefail

          gem install xcodeproj -N

          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"
          PROFILE_NAME="$(tr -d '\r\n' < ci_profile_name.txt)"
          TEAM_ID="${IOS_TEAM_ID}"

          cat > patch_runner_signing.rb <<'RUBY'
          require "xcodeproj"

          bundle_id = ENV.fetch("BUNDLE_ID")
          profile   = ENV.fetch("PROFILE_NAME")
          team_id   = ENV.fetch("TEAM_ID")

          proj_path = "ios/Runner.xcodeproj"
          project = Xcodeproj::Project.open(proj_path)

          runner = project.targets.find { |t| t.name == "Runner" }
          raise "Runner target not found" unless runner

          runner.build_configurations.each do |cfg|
            next unless cfg.name == "Release"
            s = cfg.build_settings

            s["PRODUCT_BUNDLE_IDENTIFIER"] = bundle_id
            s["CODE_SIGN_STYLE"] = "Manual"
            s["DEVELOPMENT_TEAM"] = team_id

            # App Store signing
            s["CODE_SIGN_IDENTITY"] = "Apple Distribution"
            s["PROVISIONING_PROFILE_SPECIFIER"] = profile

            # Ensure signing is ON for the app itself
            s["CODE_SIGNING_ALLOWED"] = "YES"
            s["CODE_SIGNING_REQUIRED"] = "YES"
          end

          project.save
          puts "✅ Patched Runner Release signing: #{bundle_id} / #{team_id} / #{profile}"
          RUBY

          BUNDLE_ID="$BUNDLE_ID" PROFILE_NAME="$PROFILE_NAME" TEAM_ID="$TEAM_ID" ruby patch_runner_signing.rb

      # --------------------------------------------------
      # Build iOS (flutter, no codesign)
      # --------------------------------------------------
      - name: Build iOS (flutter, no codesign)
        shell: bash
        run: |
          set -euo pipefail
          flutter build ios --release --no-codesign \
            --dart-define-from-file=lib/env/ci_env.json

      # --------------------------------------------------
      # PATCH SIGNING:
      # - Pods: remove profiles + disable signing
      # - Runner (Release): manual signing + team + profile + identity
      # IMPORTANT: Do NOT pass provisioning/profile on xcodebuild CLI
      # --------------------------------------------------
      - name: Create Runner signing xcconfig (Distribution)
        shell: bash
        run: |
          set -euo pipefail
          TEAM_ID="${IOS_TEAM_ID}"
          BUNDLE_ID="$(cat ci_ios_bundle_id.txt | tr -d '\r\n')"
          PROFILE_NAME="$(cat ci_profile_name.txt | tr -d '\r\n')"
      
          cat > ios/ci_signing.xcconfig <<EOF
          DEVELOPMENT_TEAM = ${TEAM_ID}
          PRODUCT_BUNDLE_IDENTIFIER = ${BUNDLE_ID}
          
          CODE_SIGN_STYLE = Manual
          CODE_SIGN_IDENTITY = Apple Distribution
          CODE_SIGN_IDENTITY[sdk=iphoneos*] = Apple Distribution
          
          PROVISIONING_PROFILE_SPECIFIER = ${PROFILE_NAME}
          PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*] = ${PROFILE_NAME}
          
          CODE_SIGNING_ALLOWED = YES
          CODE_SIGNING_REQUIRED = YES
          EOF

      
          echo "==== ci_signing.xcconfig ===="
          cat ios/ci_signing.xcconfig

      - name: Debug signing settings (Runner Release, with xcconfig)
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          test -f ci_signing.xcconfig || { echo "❌ ci_signing.xcconfig missing"; ls -la; exit 1; }
      
          xcodebuild -showBuildSettings \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -xcconfig ci_signing.xcconfig \
            | egrep "CODE_SIGN|DEVELOPMENT_TEAM|PROVISIONING_PROFILE|PRODUCT_BUNDLE_IDENTIFIER" || true

      - name: Force Pods = no signing, no profiles
        shell: bash
        run: |
          set -euo pipefail
          PODS_PBX="ios/Pods/Pods.xcodeproj/project.pbxproj"
          test -f "$PODS_PBX"
      
          # Remove any provisioning/profile/team/identity entries in Pods
          perl -pi -e 's/(PROVISIONING_PROFILE_SPECIFIER(\[sdk=iphoneos\*\])?) = [^;]*;/\1 = "";/g' "$PODS_PBX"
          perl -pi -e 's/PROVISIONING_PROFILE = [^;]*;/PROVISIONING_PROFILE = "";/g' "$PODS_PBX"
          perl -pi -e 's/DEVELOPMENT_TEAM = [A-Z0-9]+;/DEVELOPMENT_TEAM = "";/g' "$PODS_PBX"
          perl -pi -e 's/(CODE_SIGN_IDENTITY(\[sdk=iphoneos\*\])?) = [^;]*;/\1 = "";/g' "$PODS_PBX"
          perl -pi -e 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Automatic;/g' "$PODS_PBX"
          perl -pi -e 's/CODE_SIGNING_ALLOWED = YES;/CODE_SIGNING_ALLOWED = NO;/g' "$PODS_PBX"
          perl -pi -e 's/CODE_SIGNING_REQUIRED = YES;/CODE_SIGNING_REQUIRED = NO;/g' "$PODS_PBX"
      
          echo "✅ Pods patched (no signing)"

      - name: Verify Pods have no provisioning profile
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          xcodebuild -showBuildSettings \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release | grep -E "PROVISIONING_PROFILE|CODE_SIGN_STYLE|CODE_SIGNING_ALLOWED|DEVELOPMENT_TEAM" || true

      # --------------------------------------------------
      # ARCHIVE (do NOT pass profile/team on CLI)
      # --------------------------------------------------
      - name: Archive (xcodebuild) - Runner signs, Pods do not
        shell: bash
        run: |
          set -euo pipefail

          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"
          KEYCHAIN_PWD="ci_keychain_pwd_123"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH" || true

          mkdir -p build/ios/archive
          cd ios

          xcodebuild \
            -workspace Runner.xcworkspace \
            -scheme Runner \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath ../build/ios/archive/Runner.xcarchive \
            OTHER_CODE_SIGN_FLAGS="--keychain ${KEYCHAIN_PATH}" \
            archive






      # --------------------------------------------------
      # EXPORT IPA
      # --------------------------------------------------
      - name: Export IPA (xcodebuild)
        shell: bash
        run: |
          set -euo pipefail

          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"
          KEYCHAIN_PWD="ci_keychain_pwd_123"
          security default-keychain -s "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH" || true

          mkdir -p build/ios/ipa
          cd ios

          xcodebuild -exportArchive \
            -archivePath ../build/ios/archive/Runner.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath ../build/ios/ipa \
            OTHER_CODE_SIGN_FLAGS="--keychain ${KEYCHAIN_PATH}"


      - name: List outputs
        shell: bash
        run: |
          set -euo pipefail
          ls -la build/ios/ipa || true
          find build/ios/ipa -maxdepth 2 -type f -name "*.ipa" -print || true

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/**/*.ipa
          if-no-files-found: error

      - name: Ensure App exists on App Store Connect (produce)
        shell: bash
        run: |
          set -euo pipefail
      
          API_KEY_JSON="$GITHUB_WORKSPACE/.private/api_key.json"
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"
      
          # Prefer values from the step that writes to GITHUB_ENV:
          APP_NAME="${APPLE_APP_NAME:-}"
          SKU="${APPLE_SKU:-}"
          LOCALE="${APPLE_PRIMARY_LOCALE:-en-US}"
      
          # If not provided, fallback safely (but SKU MUST be unique)
          if [ -z "$APP_NAME" ]; then
            APP_NAME="$BUNDLE_ID"
          fi
          if [ -z "$SKU" ]; then
            # fallback SKU (change if you want): replace dots with underscores
            SKU="${BUNDLE_ID//./_}"
          fi
      
          echo "BUNDLE_ID=$BUNDLE_ID"
          echo "APP_NAME=$APP_NAME"
          echo "SKU=$SKU"
          echo "LOCALE=$LOCALE"
      
          # Create app in App Store Connect (if already exists, it will fail -> ignore)
          fastlane produce \
            --api_key_path "$API_KEY_JSON" \
            --app_identifier "$BUNDLE_ID" \
            --app_name "$APP_NAME" \
            --sku "$SKU" \
            --language "$LOCALE" \
            --skip_devcenter \
            --force \
            || true

      - name: Verify iOS SDK version (must be 18+)
        shell: bash
        run: |
          set -euo pipefail
          SDK="$(xcrun --sdk iphoneos --show-sdk-version)"
          echo "iOS SDK: $SDK"
          MAJOR="${SDK%%.*}"
          if [ "$MAJOR" -lt 18 ]; then
            echo "❌ iOS SDK must be 18+. Current: $SDK"
            exit 1
          fi

      # --------------------------------------------------
      # UPLOAD TO TESTFLIGHT (fastlane pilot)
      # --------------------------------------------------
      - name: Upload to TestFlight (pilot)
        shell: bash
        run: |
          set -euo pipefail

          API_KEY_JSON="$GITHUB_WORKSPACE/.private/api_key.json"
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"

          IPA_PATH="$(find "$GITHUB_WORKSPACE/build/ios/ipa" -type f -name "*.ipa" | head -n 1)"
          [ -f "$IPA_PATH" ] || { echo "❌ No IPA found"; exit 1; }

          echo "✅ IPA: $IPA_PATH"
          echo "✅ App: $BUNDLE_ID"

          fastlane pilot upload \
            --ipa "$IPA_PATH" \
            --api_key_path "$API_KEY_JSON" \
            --app_identifier "$BUNDLE_ID" \
            --skip_waiting_for_build_processing true


