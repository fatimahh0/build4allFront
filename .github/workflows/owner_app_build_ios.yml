name: Owner App Build (iOS IPA)

on:
  repository_dispatch:
    types: [owner_app_build_ios]

permissions:
  contents: read

jobs:
  build-ios:
    runs-on: macos-14

    env:
      CI_CALLBACK_TOKEN: ${{ secrets.CI_CALLBACK_TOKEN }}
      CI_RUNTIME_TOKEN: ${{ secrets.CI_RUNTIME_TOKEN }}

      IOS_P12_B64: ${{ secrets.IOS_P12_B64 }}
      IOS_P12_PASSWORD: ${{ secrets.IOS_P12_PASSWORD }}
      IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
      IOS_EXPORT_METHOD: ${{ secrets.IOS_EXPORT_METHOD }} # app-store
      IOS_CODE_SIGN_IDENTITY: Apple Distribution

      ASC_KEY_ID: ${{ secrets.ASC_KEY_ID }}
      ASC_ISSUER_ID: ${{ secrets.ASC_ISSUER_ID }}
      ASC_KEY_P8_B64: ${{ secrets.ASC_KEY_P8_B64 }}

      SPACESHIP_CONNECT_API_IN_HOUSE: "false"
      COCOAPODS_DISABLE_STATS: "true"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        shell: bash
        run: |
          set -euo pipefail
          sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
          xcodebuild -version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.32.0"
          channel: stable
          cache: true

      - name: Flutter pub get
        shell: bash
        run: |
          set -euo pipefail
          flutter pub get

      # --------------------------------------------------
      # BUILD RUNTIME CONFIG (bundle id)
      # --------------------------------------------------
      - name: Build ci_env.json (BY_LINK runtime-config + fallback)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p lib/env
          python3 - <<'PY'
          import json, os, urllib.request, urllib.error, socket

          payload = json.loads(r'''${{ toJson(github.event.client_payload) }}''') or {}
          cfg = payload.get("CONFIG") or {}

          api_base = (cfg.get("API_BASE_URL") or payload.get("API_BASE_URL") or "").rstrip("/")
          link_id  = str(
              cfg.get("OWNER_PROJECT_LINK_ID")
              or payload.get("OWNER_PROJECT_LINK_ID")
              or payload.get("ownerProjectLinkId")
              or cfg.get("ownerProjectLinkId")
              or ""
          ).strip()

          if not api_base:
              raise SystemExit("Missing API_BASE_URL")
          if not link_id:
              raise SystemExit("Missing OWNER_PROJECT_LINK_ID")

          url = f"{api_base}/api/public/runtime-config/by-link?linkId={link_id}"
          runtime = {}
          source = "FALLBACK"

          token = (os.getenv("CI_RUNTIME_TOKEN") or "").strip()
          headers = {"Accept": "application/json"}
          if token:
              headers["X-Auth-Token"] = token

          try:
              req = urllib.request.Request(url, headers=headers)
              with urllib.request.urlopen(req, timeout=12) as r:
                  runtime = json.loads(r.read().decode("utf-8"))
              source = "BY_LINK"
          except Exception as e:
              print("‚ö†Ô∏è runtime-config fetch failed, using fallback:", repr(e))

          ios_bundle = (
              runtime.get("iosBundleId")
              or runtime.get("IOS_BUNDLE_ID")
              or cfg.get("iosBundleId")
              or cfg.get("IOS_BUNDLE_ID")
              or payload.get("iosBundleId")
              or payload.get("IOS_BUNDLE_ID")
          )
          if not ios_bundle:
              raise SystemExit("Missing IOS_BUNDLE_ID (runtime-config must provide iosBundleId)")

          open("ci_ios_bundle_id.txt", "w", encoding="utf-8").write(str(ios_bundle).strip())

          def pick(key, default=None):
              v = runtime.get(key)
              if v not in (None, "", []):
                  return v
              v = cfg.get(key)
              if v not in (None, "", []):
                  return v
              v = payload.get(key)
              if v not in (None, "", []):
                  return v
              return default

          env = {
              "API_BASE_URL": api_base,
              "APP_NAME": pick("APP_NAME", "My App"),
              "APP_TYPE": pick("APP_TYPE", "ECOMMERCE"),
              "OWNER_PROJECT_LINK_ID": link_id,
              "PROJECT_ID": str(pick("PROJECT_ID", "")).strip(),
              "CONFIG_SOURCE": source,
          }

          with open("lib/env/ci_env.json", "w", encoding="utf-8") as f:
              json.dump(env, f, ensure_ascii=False, indent=2)
          PY

      # --------------------------------------------------
      # PATCH iOS PROJECT
      # --------------------------------------------------
      - name: Patch iOS bundle id + team in pbxproj
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"
          TEAM="${IOS_TEAM_ID}"
          PBX="ios/Runner.xcodeproj/project.pbxproj"

          perl -pi -e "s/PRODUCT_BUNDLE_IDENTIFIER = [^;]+;/PRODUCT_BUNDLE_IDENTIFIER = ${BUNDLE_ID};/g" "$PBX"
          perl -pi -e "s/DEVELOPMENT_TEAM = [A-Z0-9]+;/DEVELOPMENT_TEAM = ${TEAM};/g" "$PBX"

      # --------------------------------------------------
      # CERTIFICATE (P12) IMPORT + KEYCHAIN (FIX)
      # --------------------------------------------------
      - name: Setup iOS signing certificate (keychain)
        shell: bash
        run: |
          set -euo pipefail
          [ -n "${IOS_P12_B64:-}" ] || { echo "‚ùå Missing IOS_P12_B64"; exit 1; }
          [ -n "${IOS_P12_PASSWORD:-}" ] || { echo "‚ùå Missing IOS_P12_PASSWORD"; exit 1; }

          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"
          KEYCHAIN_PWD=""

          security create-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"

          # Make sure Xcode searches this keychain
          security list-keychains -d user -s "$KEYCHAIN_PATH" login.keychain-db
          security default-keychain -s "$KEYCHAIN_PATH"

          echo "$IOS_P12_B64" | tr -d '\n\r ' | base64 --decode > ios_cert.p12

          security import ios_cert.p12 -k "$KEYCHAIN_PATH" -P "$IOS_P12_PASSWORD" -A \
            -T /usr/bin/codesign -T /usr/bin/security -T /usr/bin/xcodebuild

          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PWD" "$KEYCHAIN_PATH"

          echo "---- identities (default keychain) ----"
          security find-identity -v -p codesigning || true

          CNT=$(security find-identity -v -p codesigning | grep -c "Apple Distribution" || true)
          if [ "$CNT" -lt 1 ]; then
            echo "‚ùå Apple Distribution identity not found in keychain search list."
            echo "üëâ Your IOS_P12_B64 is wrong OR missing private key."
            exit 1
          fi

      # --------------------------------------------------
      # RUBY + PODS + FASTLANE
      # --------------------------------------------------
      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.2"

      - name: Install CocoaPods + fastlane
        shell: bash
        run: |
          set -euo pipefail
          gem install cocoapods -N
          gem install fastlane -N
          pod --version
          fastlane --version

      - name: Install iOS Pods (safe)
        shell: bash
        run: |
          set -euo pipefail
          cd ios
          pod install || (pod repo update && pod install)

      # --------------------------------------------------
      # APP STORE CONNECT API KEY
      # --------------------------------------------------
      - name: Create App Store Connect api_key.json (verified)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .private

          [ -n "${ASC_KEY_ID:-}" ] || { echo "‚ùå ASC_KEY_ID empty"; exit 1; }
          [ -n "${ASC_ISSUER_ID:-}" ] || { echo "‚ùå ASC_ISSUER_ID empty"; exit 1; }
          [ -n "${ASC_KEY_P8_B64:-}" ] || { echo "‚ùå ASC_KEY_P8_B64 empty"; exit 1; }

          echo "${ASC_KEY_P8_B64}" | tr -d '\n\r ' | base64 --decode > .private/AuthKey_${ASC_KEY_ID}.p8

          head -n 1 .private/AuthKey_${ASC_KEY_ID}.p8 | grep -q "BEGIN PRIVATE KEY"
          tail -n 1 .private/AuthKey_${ASC_KEY_ID}.p8 | grep -q "END PRIVATE KEY"
          openssl pkey -in .private/AuthKey_${ASC_KEY_ID}.p8 -noout >/dev/null
          echo "‚úÖ OpenSSL parsed p8"

          python3 - <<'PY'
          import json, pathlib, os
          p8 = pathlib.Path(f".private/AuthKey_{os.environ['ASC_KEY_ID']}.p8").read_text()
          data = {
            "key_id": os.environ["ASC_KEY_ID"].strip(),
            "issuer_id": os.environ["ASC_ISSUER_ID"].strip(),
            "key": p8,
            "in_house": False
          }
          pathlib.Path(".private/api_key.json").write_text(json.dumps(data))
          PY

          # Quick validation by fastlane (will fail early if token is bad)
          fastlane run app_store_connect_api_key \
            key_id:"${ASC_KEY_ID}" \
            issuer_id:"${ASC_ISSUER_ID}" \
            key_filepath:"$GITHUB_WORKSPACE/.private/AuthKey_${ASC_KEY_ID}.p8" \
            in_house:false

      # --------------------------------------------------
      # PROVISIONING PROFILE (AUTO)
      # --------------------------------------------------
      - name: Automatic provisioning profile (App Store) via fastlane
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"

          fastlane run get_provisioning_profile \
            app_identifier:"$BUNDLE_ID" \
            team_id:"${IOS_TEAM_ID}" \
            api_key_path:"$GITHUB_WORKSPACE/.private/api_key.json" \
            provisioning_name:"B4A_${BUNDLE_ID}_APPSTORE" \
            readonly:false

      - name: Detect installed provisioning profile UUID/name for this app
        shell: bash
        run: |
          set -euo pipefail
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"
          APP_ID="${IOS_TEAM_ID}.${BUNDLE_ID}"

          PROFILES_DIR="$HOME/Library/MobileDevice/Provisioning Profiles"
          mkdir -p "$PROFILES_DIR"
          UUID_FOUND=""

          for f in "$PROFILES_DIR"/*.mobileprovision; do
            [ -f "$f" ] || continue
            TMP_PLIST="$(mktemp /tmp/profile.XXXXXX.plist)"
            /usr/bin/security cms -D -i "$f" > "$TMP_PLIST"
            P_APPID=$("/usr/libexec/PlistBuddy" -c "Print :Entitlements:application-identifier" "$TMP_PLIST" 2>/dev/null || true)
            if [ "$P_APPID" = "$APP_ID" ]; then
              UUID_FOUND=$("/usr/libexec/PlistBuddy" -c "Print :UUID" "$TMP_PLIST")
              PROFILE_NAME=$("/usr/libexec/PlistBuddy" -c "Print :Name" "$TMP_PLIST")
              rm -f "$TMP_PLIST"
              echo "$UUID_FOUND" > ci_profile_uuid.txt
              echo "$PROFILE_NAME" > ci_profile_name.txt
              echo "‚úÖ Using profile: $PROFILE_NAME ($UUID_FOUND)"
              break
            fi
            rm -f "$TMP_PLIST"
          done

          if [ -z "$UUID_FOUND" ]; then
            echo "‚ùå No installed profile matched $APP_ID"
            ls -la "$PROFILES_DIR" || true
            exit 1
          fi

      # --------------------------------------------------
      # FORCE DISTRIBUTION SIGNING (THIS FIXES YOUR ERROR)
      # --------------------------------------------------
      - name: Force Manual Signing + Apple Distribution (strong)
        shell: bash
        run: |
          set -euo pipefail
          PBX="ios/Runner.xcodeproj/project.pbxproj"
          TEAM="${IOS_TEAM_ID}"
          PROFILE_NAME="$(tr -d '\r\n' < ci_profile_name.txt)"
          PROFILE_UUID="$(tr -d '\r\n' < ci_profile_uuid.txt)"

          # Make signing manual everywhere
          perl -pi -e 's/CODE_SIGN_STYLE = Automatic;/CODE_SIGN_STYLE = Manual;/g' "$PBX"
          perl -pi -e "s/DEVELOPMENT_TEAM = [A-Z0-9]+;/DEVELOPMENT_TEAM = ${TEAM};/g" "$PBX"

          # Set profile
          perl -pi -e "s/PROVISIONING_PROFILE_SPECIFIER = [^;]*;/PROVISIONING_PROFILE_SPECIFIER = ${PROFILE_NAME};/g" "$PBX"
          perl -pi -e "s/PROVISIONING_PROFILE = [^;]*;/PROVISIONING_PROFILE = ${PROFILE_UUID};/g" "$PBX" || true
          perl -pi -e "s/PROVISIONING_PROFILE_SPECIFIER\\[sdk=iphoneos\\*\\] = [^;]*;/PROVISIONING_PROFILE_SPECIFIER[sdk=iphoneos*] = ${PROFILE_NAME};/g" "$PBX" || true

          # Force Distribution identity for device builds (Release)
          perl -pi -e 's/iPhone Developer/Apple Distribution/g' "$PBX"
          perl -pi -e 's/Apple Development/Apple Distribution/g' "$PBX"
          perl -pi -e 's/CODE_SIGN_IDENTITY = \"[^\"]*\";/CODE_SIGN_IDENTITY = \"Apple Distribution\";/g' "$PBX"
          perl -pi -e 's/\"CODE_SIGN_IDENTITY\[sdk=iphoneos\*\]\" = \"[^\"]*\";/\"CODE_SIGN_IDENTITY[sdk=iphoneos*]\" = \"Apple Distribution\";/g' "$PBX"

      - name: Create ExportOptions.plist
        shell: bash
        run: |
          set -euo pipefail
          METHOD="${IOS_EXPORT_METHOD:-app-store}"
          BUNDLE_ID="$(tr -d '\r\n' < ci_ios_bundle_id.txt)"
          PROFILE_NAME="$(tr -d '\r\n' < ci_profile_name.txt)"

          cat > ios/ExportOptions.plist <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>${METHOD}</string>
            <key>signingStyle</key>
            <string>manual</string>
            <key>teamID</key>
            <string>${IOS_TEAM_ID}</string>
            <key>signingCertificate</key>
            <string>Apple Distribution</string>
            <key>provisioningProfiles</key>
            <dict>
              <key>${BUNDLE_ID}</key>
              <string>${PROFILE_NAME}</string>
            </dict>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
            <key>destination</key>
            <string>export</string>
          </dict>
          </plist>
          EOF

      # --------------------------------------------------
      # BUILD IPA
      # --------------------------------------------------
      - name: Build iOS IPA (signed)
        shell: bash
        run: |
          set -euo pipefail
          KEYCHAIN_PATH="${GITHUB_WORKSPACE}/build.keychain"

          security unlock-keychain -p "" "$KEYCHAIN_PATH" || true
          security list-keychains -d user
          security default-keychain -s "$KEYCHAIN_PATH"

          echo "‚û°Ô∏è Building IPA (signed)."
          flutter build ipa --release \
            --export-options-plist=ios/ExportOptions.plist \
            --dart-define-from-file=lib/env/ci_env.json

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ios/ipa/*.ipa
          if-no-files-found: error
